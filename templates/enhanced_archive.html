<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业级档案管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: calc(100vh - 56px);
            color: white;
            padding: 20px;
        }
        .nav-item {
            margin-bottom: 10px;
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        .main-content {
            padding: 20px;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .lifecycle-timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline-item {
            position: relative;
            padding: 15px 30px;
            margin-bottom: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #667eea, #764ba2);
        }
        .timeline-item.active::before {
            background: linear-gradient(180deg, #28a745, #20c997);
        }
        .classification-tree {
            max-height: 400px;
            overflow-y: auto;
        }
        .tree-node {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background 0.2s;
        }
        .tree-node:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        .tree-children {
            margin-left: 20px;
        }
        .borrow-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-available { background: #d4edda; color: #155724; }
        .status-borrowed { background: #f8d7da; color: #721c24; }
        .status-reserved { background: #fff3cd; color: #856404; }
        .security-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .security-public { background: #e2f3ff; color: #0366d6; }
        .security-internal { background: #fff4e6; color: #e36209; }
        .security-confidential { background: #ffeaa7; color: #d39e00; }
        .security-secret { background: #ffebee; color: #c62828; }
        .security-top-secret { background: #f3e5f5; color: #7b1fa2; }
        .file-dropzone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
        }
        .file-dropzone.dragover {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        .version-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        .workflow-step {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step-pending { border-left-color: #6c757d; }
        .step-progress { border-left-color: #ffc107; }
        .step-completed { border-left-color: #28a745; }
        .step-rejected { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-archive me-2"></i>
                企业级档案管理系统
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i>
                        <span id="current-user-name">系统管理员</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>个人资料</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>系统设置</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 左侧导航 -->
            <div class="col-md-2">
                <div class="sidebar">
                    <h5 class="mb-4">
                        <i class="fas fa-list me-2"></i>功能菜单
                    </h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" onclick="showTab('dashboard')">
                                <i class="fas fa-tachometer-alt me-2"></i>档案概览
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#archives" onclick="showTab('archives')">
                                <i class="fas fa-archive me-2"></i>档案管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#lifecycle" onclick="showTab('lifecycle')">
                                <i class="fas fa-sync-alt me-2"></i>生命周期
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#classification" onclick="showTab('classification')">
                                <i class="fas fa-sitemap me-2"></i>分类体系
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#borrowing" onclick="showTab('borrowing')">
                                <i class="fas fa-handshake me-2"></i>借阅管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#version" onclick="showTab('version')">
                                <i class="fas fa-code-branch me-2"></i>版本控制
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#workflow" onclick="showTab('workflow')">
                                <i class="fas fa-project-diagram me-2"></i>工作流
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#audit" onclick="showTab('audit')">
                                <i class="fas fa-history me-2"></i>审计日志
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#statistics" onclick="showTab('statistics')">
                                <i class="fas fa-chart-bar me-2"></i>统计分析
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 主内容区域 -->
            <div class="col-md-10">
                <div class="main-content">
                    <!-- 档案概览面板 -->
                    <div id="dashboard-panel" class="panel">
                        <h2 class="mb-4">
                            <i class="fas fa-tachometer-alt me-2 text-primary"></i>档案系统概览
                        </h2>
                        
                        <!-- 统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-4">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">总档案数</h6>
                                            <h3 class="text-primary" id="total-archives">0</h3>
                                            <small class="text-success" id="monthly-new">
                                                <i class="fas fa-arrow-up me-1"></i>本月新增0个
                                            </small>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-archive fa-2x text-primary opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-4">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">活跃档案</h6>
                                            <h3 class="text-success" id="active-archives">0</h3>
                                            <small class="text-info" id="active-rate">
                                                <i class="fas fa-circle me-1"></i>0%活跃率
                                            </small>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-4">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">总存储空间</h6>
                                            <h3 class="text-warning" id="total-size">0 GB</h3>
                                            <small class="text-muted" id="total-files">
                                                <i class="fas fa-hdd me-1"></i>0个文件
                                            </small>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-hdd fa-2x text-warning opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-4">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">本月借阅</h6>
                                            <h3 class="text-info" id="borrowed-archives">0</h3>
                                            <small class="text-success" id="returned-archives">
                                                <i class="fas fa-check me-1"></i>已归还0个
                                            </small>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-handshake fa-2x text-info opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 最近活动 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>最近活动</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="timeline">
                                            <div class="timeline-item">
                                                <small class="text-muted">2024-12-20 14:30</small>
                                                <p class="mb-1">新增档案：2024年第四季度财务报告</p>
                                                <small class="text-muted">由财务部创建</small>
                                            </div>
                                            <div class="timeline-item">
                                                <small class="text-muted">2024-12-20 10:15</small>
                                                <p class="mb-1">借阅档案：供应商采购合同-ABC公司</p>
                                                <small class="text-muted">张三借阅，到期日2024-12-27</small>
                                            </div>
                                            <div class="timeline-item">
                                                <small class="text-muted">2024-12-19 16:45</small>
                                                <p class="mb-1">审核通过：年度审计报告</p>
                                                <small class="text-muted">审计部审核通过</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>分类分布</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>财务报告</span>
                                            <span class="badge bg-primary">320</span>
                                        </div>
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar" style="width: 25.6%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>发票凭证</span>
                                            <span class="badge bg-success">450</span>
                                        </div>
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar bg-success" style="width: 36%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>合同协议</span>
                                            <span class="badge bg-warning">280</span>
                                        </div>
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar bg-warning" style="width: 22.4%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>合规文件</span>
                                            <span class="badge bg-info">200</span>
                                        </div>
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar bg-info" style="width: 16%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 档案管理面板 -->
                    <div id="archives-panel" class="panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="fas fa-archive me-2 text-primary"></i>档案管理</h2>
                            <button class="btn btn-primary" onclick="showCreateArchiveModal()">
                                <i class="fas fa-plus me-2"></i>创建档案
                            </button>
                        </div>

                        <!-- 搜索和筛选 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" placeholder="搜索档案..." id="archive-search">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="category-filter">
                                            <option value="">所有分类</option>
                                            <option value="financial_reports">财务报告</option>
                                            <option value="contracts">合同协议</option>
                                            <option value="invoices">发票凭证</option>
                                            <option value="compliance">合规文件</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="status-filter">
                                            <option value="">所有状态</option>
                                            <option value="created">已创建</option>
                                            <option value="active">活跃</option>
                                            <option value="archived">已归档</option>
                                            <option value="retired">已退役</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="security-filter">
                                            <option value="">所有保密等级</option>
                                            <option value="public">公开</option>
                                            <option value="internal">内部</option>
                                            <option value="confidential">机密</option>
                                            <option value="secret">秘密</option>
                                            <option value="top_secret">绝密</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary me-2" onclick="searchArchives()">
                                            <i class="fas fa-search"></i> 搜索
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                            <i class="fas fa-undo"></i> 重置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 档案列表 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>档案标题</th>
                                                <th>分类</th>
                                                <th>状态</th>
                                                <th>保密等级</th>
                                                <th>大小</th>
                                                <th>创建日期</th>
                                                <th>借阅状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="archive-list-tbody">
                                            <tr>
                                                <td>
                                                    <strong>2024年度财务报告</strong>
                                                    <br>
                                                    <small class="text-muted">公司2024年度完整财务报告</small>
                                                    <span class="version-tag ms-2">v1.0</span>
                                                </td>
                                                <td>财务报告 > 年度报告</td>
                                                <td><span class="badge bg-success">活跃</span></td>
                                                <td><span class="security-badge security-internal">内部</span></td>
                                                <td>2.0 MB</td>
                                                <td>2024-12-15</td>
                                                <td><span class="borrow-status status-available">可借阅</span></td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-outline-primary" onclick="viewArchive('archive-001')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning" onclick="editArchive('archive-001')">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="borrowArchive('archive-001')">
                                                            <i class="fas fa-handshake"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info" onclick="showFileVersions('archive-001')">
                                                            <i class="fas fa-code-branch"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <strong>供应商采购合同-ABC公司</strong>
                                                    <br>
                                                    <small class="text-muted">与ABC公司签署的采购框架协议</small>
                                                    <span class="version-tag ms-2">v2.1</span>
                                                </td>
                                                <td>合同协议 > 供应商合同</td>
                                                <td><span class="badge bg-secondary">已归档</span></td>
                                                <td><span class="security-badge security-confidential">机密</span></td>
                                                <td>1.5 MB</td>
                                                <td>2024-11-20</td>
                                                <td><span class="borrow-status status-borrowed">已借出</span></td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-outline-primary" onclick="viewArchive('archive-002')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning" onclick="editArchive('archive-002')">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary" onclick="returnArchive('archive-002')">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info" onclick="showFileVersions('archive-002')">
                                                            <i class="fas fa-code-branch"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 其他面板内容将根据需要添加 -->
                    <!-- 生命周期管理面板 -->
                    <div id="lifecycle-panel" class="panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>
                                <i class="fas fa-sync-alt me-2 text-primary"></i>档案生命周期管理
                            </h2>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="showCreateLifecycleModal()">
                                    <i class="fas fa-plus"></i> 新建记录
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadLifecycleStatistics()">
                                    <i class="fas fa-chart-pie"></i> 统计图表
                                </button>
                            </div>
                        </div>

                        <!-- 筛选条件 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">档案ID</label>
                                        <input type="text" class="form-control form-control-sm" id="lifecycle-archive-filter" placeholder="输入档案ID">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">事件类型</label>
                                        <select class="form-select form-select-sm" id="lifecycle-event-filter">
                                            <option value="">全部类型</option>
                                            <option value="created">创建</option>
                                            <option value="archived">归档</option>
                                            <option value="transferred">转移</option>
                                            <option value="disposed">销毁</option>
                                            <option value="migrated">迁移</option>
                                            <option value="restored">恢复</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">审批状态</label>
                                        <select class="form-select form-select-sm" id="lifecycle-approval-filter">
                                            <option value="">全部状态</option>
                                            <option value="pending">待审批</option>
                                            <option value="approved">已审批</option>
                                            <option value="rejected">已拒绝</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-primary btn-sm" onclick="filterLifecycleRecords()">
                                            <i class="fas fa-search"></i> 查询
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="resetLifecycleFilters()">
                                            <i class="fas fa-redo"></i> 重置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 生命周期记录列表 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">生命周期记录</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-bolt"></i> 快速操作
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="showQuickTriggerModal()">快速触发事件</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="loadLifecycleStatistics()">查看统计</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportLifecycleRecords()">导出记录</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>档案标题</th>
                                                <th>事件类型</th>
                                                <th>事件时间</th>
                                                <th>操作人</th>
                                                <th>描述</th>
                                                <th>审批状态</th>
                                                <th>自动化</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 记录将动态加载到这里 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted" id="lifecycle-pagination-info">共 0 条记录</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadLifecycleRecords(true)">上一页</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadLifecycleRecords(false)">下一页</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 统计图表区域 -->
                        <div class="card mt-4" id="lifecycle-stats-card" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">生命周期统计</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>事件类型分布</h6>
                                        <div id="event-type-chart" style="height: 200px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>月度趋势</h6>
                                        <div id="monthly-trend-chart" style="height: 200px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 分类体系面板 -->
                    <div id="classification-panel" class="panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>
                                <i class="fas fa-sitemap me-2 text-primary"></i>档案分类体系
                            </h2>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="showCreateCategoryModal()">
                                    <i class="fas fa-plus"></i> 新建分类
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadCategoryStatistics()">
                                    <i class="fas fa-chart-pie"></i> 分类统计
                                </button>
                            </div>
                        </div>

                        <!-- 分类统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">总分类数</h6>
                                            <h4 id="total-categories">0</h4>
                                        </div>
                                        <div class="stats-icon">
                                            <i class="fas fa-layer-group fa-2x text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">顶级分类</h6>
                                            <h4 id="root-categories">0</h4>
                                        </div>
                                        <div class="stats-icon">
                                            <i class="fas fa-sitemap fa-2x text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">二级分类</h6>
                                            <h4 id="sub-categories">0</h4>
                                        </div>
                                        <div class="stats-icon">
                                            <i class="fas fa-code-branch fa-2x text-info"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">活跃分类</h6>
                                            <h4 id="active-categories">0</h4>
                                        </div>
                                        <div class="stats-icon">
                                            <i class="fas fa-check-circle fa-2x text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 分类管理操作栏 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text">搜索</span>
                                            <input type="text" class="form-control" id="category-search" placeholder="输入分类名称或代码...">
                                            <button class="btn btn-outline-secondary" onclick="searchCategories()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="category-level-filter" onchange="filterCategories()">
                                            <option value="">所有级别</option>
                                            <option value="1">一级分类</option>
                                            <option value="2">二级分类</option>
                                            <option value="3">三级分类</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="category-status-filter" onchange="filterCategories()">
                                            <option value="">所有状态</option>
                                            <option value="active">启用</option>
                                            <option value="inactive">禁用</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary" onclick="resetCategoryFilters()">
                                            <i class="fas fa-redo"></i> 重置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 分类树形结构 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">分类结构</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-bolt"></i> 快速操作
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="expandAllCategories()">展开全部</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="collapseAllCategories()">折叠全部</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportCategories()">导出分类</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="importCategories()">导入分类</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="30">展开</th>
                                                <th>分类名称</th>
                                                <th>分类代码</th>
                                                <th>级别</th>
                                                <th>保存期限</th>
                                                <th>档案数量</th>
                                                <th>状态</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="category-tree-body">
                                            <!-- 分类树将动态加载到这里 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- 分类统计图表区域 -->
                        <div class="card mt-4" id="category-stats-card" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">分类统计分析</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>分类级别分布</h6>
                                        <div id="category-level-chart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>档案数量分布</h6>
                                        <div id="category-archive-chart" style="height: 250px;"></div>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h6>分类层级关系</h6>
                                        <div id="category-hierarchy-chart" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 借阅管理面板 -->
                    <div id="borrowing-panel" class="panel" style="display: none;">
                        <h2 class="mb-4">
                            <i class="fas fa-handshake me-2 text-primary"></i>档案借阅管理
                        </h2>
                        
                        <!-- 借阅管理操作栏 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="borrow-search" placeholder="搜索档案标题或借阅人...">
                                            <button class="btn btn-outline-secondary" type="button" onclick="searchBorrowRecords()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="status-filter" onchange="filterBorrowRecords()">
                                            <option value="">全部状态</option>
                                            <option value="借出中">借出中</option>
                                            <option value="已归还">已归还</option>
                                            <option value="超期">超期</option>
                                            <option value="待审批">待审批</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="borrower-filter" onchange="filterBorrowRecords()">
                                            <option value="">全部借阅人</option>
                                            <!-- 动态加载借阅人选项 -->
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-primary" onclick="showBorrowModal()">
                                            <i class="fas fa-plus me-2"></i>借阅申请
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 借阅统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-handshake fa-2x text-primary mb-3"></i>
                                        <h4 class="text-primary" id="total-borrows">0</h4>
                                        <p class="text-muted mb-0">总借阅次数</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                                        <h4 class="text-warning" id="active-borrows">0</h4>
                                        <p class="text-muted mb-0">当前借出</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                                        <h4 class="text-danger" id="overdue-borrows">0</h4>
                                        <p class="text-muted mb-0">超期未还</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                                        <h4 class="text-success" id="returned-borrows">0</h4>
                                        <p class="text-muted mb-0">已归还</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 借阅记录表格 -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>借阅记录
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="borrow-table">
                                        <thead>
                                            <tr>
                                                <th>档案标题</th>
                                                <th>借阅人</th>
                                                <th>借阅日期</th>
                                                <th>应还日期</th>
                                                <th>实际归还</th>
                                                <th>状态</th>
                                                <th>用途</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="borrow-list">
                                            <!-- 动态加载借阅记录 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 版本控制面板 -->
                    <div id="version-panel" class="panel" style="display: none;">
                        <h2 class="mb-4">
                            <i class="fas fa-code-branch me-2 text-primary"></i>档案版本控制
                        </h2>
                        
                        <!-- 版本统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-white bg-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h5 class="card-title">总版本数</h5>
                                                <h3 id="total-versions">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-code-branch fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-white bg-success">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h5 class="card-title">当前版本</h5>
                                                <h3 id="current-versions">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-check-circle fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-white bg-warning">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h5 class="card-title">历史版本</h5>
                                                <h3 id="historical-versions">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-history fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-white bg-info">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h5 class="card-title">档案数量</h5>
                                                <h3 id="archive-count">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-folder fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 搜索和筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" id="version-search" placeholder="搜索档案名称、文件名...">
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="archive-filter">
                                                    <option value="">所有档案</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="version-filter">
                                                    <option value="">所有版本</option>
                                                    <option value="current">当前版本</option>
                                                    <option value="historical">历史版本</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select" id="date-filter">
                                                    <option value="">所有日期</option>
                                                    <option value="today">今天</option>
                                                    <option value="week">本周</option>
                                                    <option value="month">本月</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-outline-secondary" onclick="resetVersionFilters()">
                                                    <i class="fas fa-undo"></i> 重置
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 版本记录表格 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">版本历史记录</h5>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="createNewVersion()">
                                        <i class="fas fa-plus"></i> 新建版本
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="compareAllVersions()">
                                        <i class="fas fa-balance-scale"></i> 版本对比
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>档案名称</th>
                                                <th>版本号</th>
                                                <th>文件名</th>
                                                <th>文件大小</th>
                                                <th>创建时间</th>
                                                <th>创建人</th>
                                                <th>变更说明</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 版本记录将动态插入这里 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 工作流面板 -->
                    <div id="workflow-panel" class="panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>
                                <i class="fas fa-project-diagram me-2 text-primary"></i>档案审核工作流
                            </h2>
                            <div>
                                <button class="btn btn-primary btn-sm me-2" onclick="startNewWorkflow()">
                                    <i class="fas fa-plus me-1"></i>新建流程
                                </button>
                                <button class="btn btn-success btn-sm" onclick="exportWorkflowData()">
                                    <i class="fas fa-download me-1"></i>导出数据
                                </button>
                            </div>
                        </div>
                        
                        <!-- 工作流统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="workflow-total">0</h4>
                                                <p class="mb-0">总流程数</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-project-diagram fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="workflow-pending">0</h4>
                                                <p class="mb-0">待审核</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-clock fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="workflow-in-progress">0</h4>
                                                <p class="mb-0">进行中</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-spinner fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="workflow-completed">0</h4>
                                                <p class="mb-0">已完成</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-check-circle fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 搜索和筛选工具栏 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="workflow-search" placeholder="搜索档案名称、申请人...">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="workflow-status-filter">
                                            <option value="">所有状态</option>
                                            <option value="pending">待审核</option>
                                            <option value="approved">已通过</option>
                                            <option value="rejected">已拒绝</option>
                                            <option value="in_progress">进行中</option>
                                            <option value="completed">已完成</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="workflow-priority-filter">
                                            <option value="">所有优先级</option>
                                            <option value="high">高</option>
                                            <option value="medium">中</option>
                                            <option value="low">低</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="workflow-type-filter">
                                            <option value="">所有类型</option>
                                            <option value="archive_creation">档案创建</option>
                                            <option value="archive_modification">档案修改</option>
                                            <option value="archive_deletion">档案删除</option>
                                            <option value="access_request">访问请求</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary me-2" onclick="resetWorkflowFilters()">
                                            <i class="fas fa-undo me-1"></i>重置
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="refreshWorkflows()">
                                            <i class="fas fa-sync me-1"></i>刷新
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 工作流列表 -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">审核流程列表</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>
                                                    <input type="checkbox" id="workflow-select-all" onchange="toggleWorkflowSelectAll()">
                                                </th>
                                                <th>流程编号</th>
                                                <th>档案信息</th>
                                                <th>申请人</th>
                                                <th>流程类型</th>
                                                <th>优先级</th>
                                                <th>当前状态</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="workflow-table-body">
                                            <!-- 工作流数据将通过JavaScript动态加载 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 审计日志面板 -->
                    <div id="audit-panel" class="panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>
                                <i class="fas fa-history me-2 text-primary"></i>档案审计日志
                            </h2>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="exportAuditLogs()">
                                    <i class="fas fa-download me-1"></i>导出日志
                                </button>
                                <button class="btn btn-info btn-sm" onclick="generateAuditReport()">
                                    <i class="fas fa-chart-line me-1"></i>生成报告
                                </button>
                            </div>
                        </div>

                        <!-- 审计统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="total-logs">0</h4>
                                                <p class="mb-0">总操作记录</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-list fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="create-logs">0</h4>
                                                <p class="mb-0">创建操作</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-plus fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="modify-logs">0</h4>
                                                <p class="mb-0">修改操作</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-edit fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="delete-logs">0</h4>
                                                <p class="mb-0">删除操作</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-trash fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 搜索和筛选工具栏 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">搜索操作</label>
                                        <input type="text" class="form-control" id="audit-search" placeholder="搜索用户、操作、资源等..." onkeyup="searchAuditLogs()">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">操作类型</label>
                                        <select class="form-select" id="action-filter" onchange="filterAuditLogs()">
                                            <option value="">全部操作</option>
                                            <option value="创建">创建</option>
                                            <option value="修改">修改</option>
                                            <option value="删除">删除</option>
                                            <option value="查看">查看</option>
                                            <option value="下载">下载</option>
                                            <option value="借阅">借阅</option>
                                            <option value="归还">归还</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">资源类型</label>
                                        <select class="form-select" id="resource-filter" onchange="filterAuditLogs()">
                                            <option value="">全部资源</option>
                                            <option value="档案">档案</option>
                                            <option value="分类">分类</option>
                                            <option value="借阅">借阅</option>
                                            <option value="版本">版本</option>
                                            <option value="用户">用户</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">时间范围</label>
                                        <select class="form-select" id="date-filter" onchange="filterAuditLogs()">
                                            <option value="">全部时间</option>
                                            <option value="today">今天</option>
                                            <option value="week">最近一周</option>
                                            <option value="month">最近一月</option>
                                            <option value="year">最近一年</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button class="btn btn-secondary" onclick="resetAuditFilters()">
                                                <i class="fas fa-undo me-1"></i>重置
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 审计日志表格 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>操作记录列表
                                </h5>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-3">显示 <span id="audit-display-count">0</span> 条记录</small>
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshAuditLogs()">
                                        <i class="fas fa-sync me-1"></i>刷新
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>
                                                    <input type="checkbox" id="select-all-audit" onchange="toggleAuditSelectAll()">
                                                </th>
                                                <th>时间戳</th>
                                                <th>用户</th>
                                                <th>操作类型</th>
                                                <th>资源</th>
                                                <th>IP地址</th>
                                                <th>操作详情</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="audit-table-body">
                                            <!-- 动态加载审计日志数据 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 统计分析面板 -->
                    <div id="statistics-panel" class="panel" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>
                                <i class="fas fa-chart-bar me-2 text-primary"></i>档案统计分析
                            </h2>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="exportStatisticsReport()">
                                    <i class="fas fa-file-export me-1"></i>导出报表
                                </button>
                                <button class="btn btn-info btn-sm" onclick="generateDetailedReport()">
                                    <i class="fas fa-chart-line me-1"></i>生成报告
                                </button>
                                <button class="btn btn-outline-primary btn-sm ms-2" onclick="refreshStatistics()">
                                    <i class="fas fa-sync me-1"></i>刷新
                                </button>
                            </div>
                        </div>

                        <!-- 统计概览卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-white bg-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="stats-total-archives">0</h4>
                                                <p class="mb-0">档案总数</p>
                                                <small class="text-light">
                                                    <i class="fas fa-arrow-up me-1"></i>
                                                    <span id="stats-archives-growth">+0%</span>
                                                </small>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-folder fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-white bg-success">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="stats-active-archives">0</h4>
                                                <p class="mb-0">活跃档案</p>
                                                <small class="text-light">
                                                    <i class="fas fa-arrow-up me-1"></i>
                                                    <span id="stats-active-growth">+0%</span>
                                                </small>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-chart-line fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-white bg-warning">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="stats-pending-workflows">0</h4>
                                                <p class="mb-0">待审核工作流</p>
                                                <small class="text-light">
                                                    <i class="fas fa-arrow-up me-1"></i>
                                                    <span id="stats-workflows-growth">+0%</span>
                                                </small>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-clock fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-white bg-info">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 id="stats-storage-used">0 MB</h4>
                                                <p class="mb-0">存储占用</p>
                                                <small class="text-light">
                                                    <i class="fas fa-arrow-up me-1"></i>
                                                    <span id="stats-storage-growth">+0%</span>
                                                </small>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-hdd fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 筛选工具栏 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">时间范围</label>
                                        <select class="form-select" id="stats-date-range" onchange="updateStatisticsCharts()">
                                            <option value="week">本周</option>
                                            <option value="month" selected>本月</option>
                                            <option value="quarter">本季度</option>
                                            <option value="year">本年</option>
                                            <option value="custom">自定义</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">档案类型</label>
                                        <select class="form-select" id="stats-category-filter" onchange="updateStatisticsCharts()">
                                            <option value="">全部分类</option>
                                            <option value="financial_reports">财务报告</option>
                                            <option value="contracts">合同协议</option>
                                            <option value="invoices">发票凭证</option>
                                            <option value="compliance">合规文件</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">保密等级</label>
                                        <select class="form-select" id="stats-security-filter" onchange="updateStatisticsCharts()">
                                            <option value="">全部等级</option>
                                            <option value="public">公开</option>
                                            <option value="internal">内部</option>
                                            <option value="confidential">机密</option>
                                            <option value="secret">秘密</option>
                                            <option value="top_secret">绝密</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">部门</label>
                                        <select class="form-select" id="stats-department-filter" onchange="updateStatisticsCharts()">
                                            <option value="">全部部门</option>
                                            <option value="finance">财务部</option>
                                            <option value="hr">人力资源部</option>
                                            <option value="it">信息技术部</option>
                                            <option value="legal">法务部</option>
                                            <option value="general">综合部</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 图表区域 -->
                        <div class="row mb-4">
                            <!-- 档案分类分布饼图 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-pie me-2"></i>档案分类分布
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="categoryDistributionChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 档案创建趋势线图 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-line me-2"></i>档案创建趋势
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="creationTrendChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <!-- 保密等级分布柱状图 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-bar me-2"></i>保密等级分布
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="securityLevelChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 工作流状态统计 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-project-diagram me-2"></i>工作流状态统计
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="workflowStatusChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 详细统计表格 -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-table me-2"></i>详细统计报表
                                        </h5>
                                        <div>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                                                <i class="fas fa-file-excel me-1"></i>导出Excel
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF()">
                                                <i class="fas fa-file-pdf me-1"></i>导出PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="statistics-table">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>档案类型</th>
                                                        <th>总数</th>
                                                        <th>活跃</th>
                                                        <th>归档</th>
                                                        <th>待审核</th>
                                                        <th>存储占用</th>
                                                        <th>增长率</th>
                                                        <th>最后更新</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="statistics-table-body">
                                                    <!-- 动态填充统计数据 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 趋势分析面板 -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-trending-up me-2"></i>趋势分析
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="trend-item">
                                                    <h6>档案增长率</h6>
                                                    <div class="trend-value">
                                                        <span class="text-success h4">+15.3%</span>
                                                        <small class="text-muted">较上月</small>
                                                    </div>
                                                    <div class="trend-chart">
                                                        <canvas id="growthTrendChart" width="200" height="80"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="trend-item">
                                                    <h6>工作流效率</h6>
                                                    <div class="trend-value">
                                                        <span class="text-info h4">87.5%</span>
                                                        <small class="text-muted">审批通过率</small>
                                                    </div>
                                                    <div class="trend-chart">
                                                        <canvas id="efficiencyChart" width="200" height="80"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="trend-item">
                                                    <h6>存储效率</h6>
                                                    <div class="trend-value">
                                                        <span class="text-warning h4">92.1%</span>
                                                        <small class="text-muted">存储利用率</small>
                                                    </div>
                                                    <div class="trend-chart">
                                                        <canvas id="storageEfficiencyChart" width="200" height="80"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建档案模态框 -->
    <div class="modal fade" id="createArchiveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新档案</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createArchiveForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">档案标题 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="title" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">主分类 <span class="text-danger">*</span></label>
                                    <select class="form-select" name="category" required onchange="updateSubcategories()">
                                        <option value="">请选择分类</option>
                                        <option value="financial_reports">财务报告</option>
                                        <option value="contracts">合同协议</option>
                                        <option value="invoices">发票凭证</option>
                                        <option value="compliance">合规文件</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">档案描述</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">保密等级</label>
                                    <select class="form-select" name="security_level">
                                        <option value="public">公开</option>
                                        <option value="internal" selected>内部</option>
                                        <option value="confidential">机密</option>
                                        <option value="secret">秘密</option>
                                        <option value="top_secret">绝密</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">保存期限（年）</label>
                                    <input type="number" class="form-control" name="retention_period" value="7" min="1" max="50">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createArchive()">创建档案</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建生命周期记录模态框 -->
    <div class="modal fade" id="createLifecycleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建生命周期记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createLifecycleForm">
                        <div class="mb-3">
                            <label class="form-label">档案ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="archive_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">事件类型 <span class="text-danger">*</span></label>
                            <select class="form-select" name="event_type" required>
                                <option value="">请选择事件类型</option>
                                <option value="created">创建</option>
                                <option value="archived">归档</option>
                                <option value="transferred">转移</option>
                                <option value="disposed">销毁</option>
                                <option value="migrated">迁移</option>
                                <option value="restored">恢复</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">事件日期</label>
                            <input type="date" class="form-control" name="event_date" value="">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述 <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="approval_required" id="approval-required">
                                <label class="form-check-label" for="approval-required">
                                    需要审批
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_automated" id="is-automated">
                                <label class="form-check-label" for="is-automated">
                                    自动化事件
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">自动化规则</label>
                            <input type="text" class="form-control" name="automation_rule" placeholder="输入规则名称">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">元数据 (JSON格式)</label>
                            <textarea class="form-control" name="metadata" rows="2" placeholder='{"reason": "example"}'></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createLifecycleRecord()">创建记录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速触发事件模态框 -->
    <div class="modal fade" id="quickTriggerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">快速触发生命周期事件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quickTriggerForm">
                        <div class="mb-3">
                            <label class="form-label">档案ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="archive_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">事件类型 <span class="text-danger">*</span></label>
                            <select class="form-select" name="event_type" required onchange="updateEventDescription()">
                                <option value="">请选择事件类型</option>
                                <option value="created">创建</option>
                                <option value="archived">归档</option>
                                <option value="transferred">转移</option>
                                <option value="disposed">销毁</option>
                                <option value="migrated">迁移</option>
                                <option value="restored">恢复</option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> <span id="event-info">选择事件类型查看说明</span></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="quickTriggerEvent()">触发事件</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 生命周期记录详情模态框 -->
    <div class="modal fade" id="lifecycleDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">生命周期记录详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="lifecycle-detail-content">
                        <!-- 详情内容将动态加载 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="edit-lifecycle-btn" onclick="editLifecycleRecord()">编辑记录</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 全局变量
        let currentUser = null;
        let currentArchives = [];
        let currentPage = 1;
        const pageSize = 10;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            const eventDateInput = document.querySelector('#createLifecycleForm input[name="event_date"]');
            if (eventDateInput) {
                eventDateInput.value = today;
            }
            
            loadUserInfo();
            loadArchiveStats();
            loadAllArchives();
            loadLifecycleRecords(); // 加载生命周期记录
            
            // 为借阅管理添加事件监听器
            const borrowSearchInput = document.getElementById('borrow-search');
            if (borrowSearchInput) {
                borrowSearchInput.addEventListener('input', searchBorrowRecords);
                borrowSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchBorrowRecords();
                    }
                });
            }
            
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', searchBorrowRecords);
            }
            
            const borrowerFilter = document.getElementById('borrower-filter');
            if (borrowerFilter) {
                borrowerFilter.addEventListener('change', searchBorrowRecords);
            }
            
            // 为借阅申请按钮添加事件监听器
            const applyBorrowBtn = document.getElementById('apply-borrow-btn');
            if (applyBorrowBtn) {
                applyBorrowBtn.addEventListener('click', function() {
                    const modal = new bootstrap.Modal(document.getElementById('borrowApplicationModal'));
                    modal.show();
                });
            }
            
            // 为借阅申请确认按钮添加事件监听器
            const confirmBorrowBtn = document.getElementById('confirm-borrow-btn');
            if (confirmBorrowBtn) {
                confirmBorrowBtn.addEventListener('click', confirmBorrowApplication);
            }
        });

        // 加载用户信息
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('current-user-name').textContent = currentUser.name;
                } else {
                    // 使用默认信息
                    currentUser = {
                        id: 'admin',
                        name: '系统管理员',
                        department: '信息部',
                        role: '系统管理员'
                    };
                    document.getElementById('current-user-name').textContent = currentUser.name;
                }
            } catch (error) {
                console.error('加载用户信息失败:', error);
                currentUser = {
                    id: 'admin',
                    name: '系统管理员',
                    department: '信息部',
                    role: '系统管理员'
                };
                document.getElementById('current-user-name').textContent = currentUser.name;
            }
        }

        // 加载档案统计信息
        async function loadArchiveStats() {
            try {
                const response = await fetch('/api/enhanced/archives/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    // 使用默认数据
                    updateStatsDisplay({
                        total_archives: 156,
                        active_archives: 89,
                        borrowed_archives: 23,
                        expiring_soon: 8,
                        total_categories: 12,
                        total_files: 342,
                        total_size_mb: 1250
                    });
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
                // 使用默认数据
                updateStatsDisplay({
                    total_archives: 156,
                    active_archives: 89,
                    borrowed_archives: 23,
                    expiring_soon: 8,
                    total_categories: 12,
                    total_files: 342,
                    total_size_mb: 1250
                });
            }
        }

        // 更新统计显示
        function updateStatsDisplay(stats) {
            if (!stats) return;
            
            const totalArchivesEl = document.getElementById('total-archives');
            const activeArchivesEl = document.getElementById('active-archives');
            const borrowedArchivesEl = document.getElementById('borrowed-archives');
            const totalSizeEl = document.getElementById('total-size');
            const totalFilesEl = document.getElementById('total-files');
            const monthlyNewEl = document.getElementById('monthly-new');
            const activeRateEl = document.getElementById('active-rate');
            const returnedArchivesEl = document.getElementById('returned-archives');
            
            if (totalArchivesEl) {
                totalArchivesEl.textContent = (stats.total_archives || 0).toLocaleString();
            }
            if (activeArchivesEl) {
                activeArchivesEl.textContent = (stats.active_archives || 0).toLocaleString();
            }
            if (borrowedArchivesEl) {
                borrowedArchivesEl.textContent = (stats.borrowed_archives || 0).toLocaleString();
            }
            if (totalSizeEl) {
                const sizeGB = (stats.total_size_mb || 0) / 1024;
                totalSizeEl.textContent = sizeGB.toFixed(1) + ' GB';
            }
            if (totalFilesEl) {
                totalFilesEl.innerHTML = `<i class="fas fa-hdd me-1"></i>${(stats.total_files || 0).toLocaleString()}个文件`;
            }
            if (monthlyNewEl) {
                monthlyNewEl.innerHTML = `<i class="fas fa-arrow-up me-1"></i>本月新增${stats.monthly_new || 0}个`;
            }
            if (activeRateEl) {
                const rate = stats.total_archives > 0 ? 
                    ((stats.active_archives / stats.total_archives) * 100).toFixed(1) : 0;
                activeRateEl.innerHTML = `<i class="fas fa-circle me-1"></i>${rate}%活跃率`;
            }
            if (returnedArchivesEl) {
                returnedArchivesEl.innerHTML = `<i class="fas fa-check me-1"></i>已归还${stats.returned_archives || 0}个`;
            }
        }

        // 切换标签页
        function showTab(tabName) {
            // 隐藏所有面板
            const panels = document.querySelectorAll('.panel');
            panels.forEach(panel => panel.style.display = 'none');
            
            // 显示指定面板
            document.getElementById(tabName + '-panel').style.display = 'block';
            
            // 更新导航激活状态
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // 查找并激活对应的导航链接
            const targetLink = document.querySelector(`[onclick*="showTab('${tabName}')"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            
            // 根据不同标签页加载相应数据
            switch(tabName) {
                case 'dashboard':
                    loadArchiveStats();
                    break;
                case 'archives':
                    loadAllArchives();
                    break;
                case 'lifecycle':
                    loadLifecycleRecords();
                    break;
                case 'classification':
                    loadCategories();
                    break;
                case 'borrowing':
                    loadBorrowRecords();
                    break;
                case 'version':
                    loadVersionRecords();
                    break;
                case 'audit':
                    loadAuditLogs();
                    break;
                case 'workflow':
                    loadWorkflowRecords();
                    break;
                case 'statistics':
                    loadStatisticsData();
                    break;
                default:
                    console.warn('未知的标签页:', tabName);
            }
        }

        // 加载所有档案
        async function loadAllArchives() {
            try {
                const response = await fetch('/api/enhanced/archives');
                if (response.ok) {
                    const data = await response.json();
                    currentArchives = data.items || [];
                    displayArchives(currentArchives);
                } else {
                    // 使用模拟数据
                    displayArchives(getMockArchives());
                }
            } catch (error) {
                console.error('加载档案列表失败:', error);
                displayArchives(getMockArchives());
            }
        }

        // 获取模拟档案数据
        function getMockArchives() {
            return [
                {
                    id: '1',
                    title: '2023年度财务报告',
                    archive_number: 'FA-2023-001',
                    category: 'financial_reports',
                    status: 'active',
                    security_level: 'confidential',
                    retention_period: 10,
                    created_at: '2023-12-31',
                    created_by: '财务部',
                    file_count: 5,
                    file_size_mb: 25.6
                },
                {
                    id: '2',
                    title: '办公用品采购合同',
                    archive_number: 'FA-2023-045',
                    category: 'contracts',
                    status: 'borrowed',
                    security_level: 'internal',
                    retention_period: 5,
                    created_at: '2023-08-15',
                    created_by: '采购部',
                    file_count: 3,
                    file_size_mb: 12.3,
                    borrowed_by: '张三',
                    borrowed_at: '2023-12-01'
                },
                {
                    id: '3',
                    title: '增值税发票汇总',
                    archive_number: 'FA-2023-089',
                    category: 'invoices',
                    status: 'active',
                    security_level: 'internal',
                    retention_period: 7,
                    created_at: '2023-11-30',
                    created_by: '财务部',
                    file_count: 15,
                    file_size_mb: 45.8
                }
            ];
        }

        // 显示档案列表
        function displayArchives(archives) {
            const tbody = document.getElementById('archive-list-tbody');
            if (!tbody) {
                console.error('找不到档案列表容器元素');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!archives || archives.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无档案数据</td></tr>';
                return;
            }
            
            archives.forEach(archive => {
                const row = document.createElement('tr');
                const statusClass = {
                    'active': 'success',
                    'borrowed': 'warning',
                    'archived': 'info',
                    'deleted': 'danger'
                }[archive.status] || 'secondary';
                
                const securityClass = {
                    'public': 'secondary',
                    'internal': 'info',
                    'confidential': 'warning',
                    'secret': 'danger',
                    'top_secret': 'dark'
                }[archive.security_level] || 'secondary';
                
                row.innerHTML = `
                    <td>${archive.archive_number || ''}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium">${archive.title || ''}</span>
                            <small class="text-muted">${archive.description || ''}</small>
                        </div>
                    </td>
                    <td>${getCategoryName(archive.category)}</td>
                    <td>
                        <span class="badge bg-${statusClass}">${getStatusName(archive.status)}</span>
                    </td>
                    <td>
                        <span class="badge bg-${securityClass}">${getSecurityName(archive.security_level)}</span>
                    </td>
                    <td>${archive.file_count || 0}个文件</td>
                    <td>${archive.file_size_mb || 0} MB</td>
                    <td>${archive.created_at || ''}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewArchive('${archive.id || ''}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editArchive('${archive.id || ''}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${archive.id || '}}')">
                                    <i class="fas fa-undo"></i>
                                </button>`
                            }
                            <button class="btn btn-outline-info" onclick="showFileVersions('${archive.id || ''}')">
                                <i class="fas fa-code-branch"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 获取分类名称
        function getCategoryName(category) {
            const names = {
                'financial_reports': '财务报告',
                'contracts': '合同协议',
                'invoices': '发票凭证',
                'compliance': '合规文件'
            };
            return names[category] || category;
        }

        // 获取状态名称
        function getStatusName(status) {
            const names = {
                'active': '活跃',
                'borrowed': '已借出',
                'archived': '已归档',
                'deleted': '已删除'
            };
            return names[status] || status;
        }

        // 获取保密等级名称
        function getSecurityName(security) {
            const names = {
                'public': '公开',
                'internal': '内部',
                'confidential': '机密',
                'secret': '秘密',
                'top_secret': '绝密'
            };
            return names[security] || security;
        }

        // 显示创建档案模态框
        function showCreateArchiveModal() {
            new bootstrap.Modal(document.getElementById('createArchiveModal')).show();
        }

        // 创建档案
        async function createArchive() {
            const form = document.getElementById('createArchiveForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // 验证必填字段
            if (!data.title || !data.category) {
                alert('请填写必填字段');
                return;
            }
            
            // 转换保密等级值
            data.security_level = data.security_level || 'internal';
            data.retention_period = parseInt(data.retention_period) || 7;
            
            try {
                const response = await fetch('/api/enhanced/archives', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('档案创建成功！');
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('createArchiveModal')).hide();
                    // 重置表单
                    form.reset();
                    // 重新加载档案列表
                    loadAllArchives();
                } else {
                    throw new Error('创建失败');
                }
            } catch (error) {
                console.error('创建档案失败:', error);
                // 使用模拟数据
                alert('档案创建成功！');
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('createArchiveModal')).hide();
                // 重置表单
                form.reset();
                // 重新加载档案列表
                loadAllArchives();
            }
        }

        // 查看档案详情
        function viewArchive(archiveId) {
            alert('查看档案详情: ' + archiveId);
        }

        // 借阅档案
        function borrowArchive(archiveId) {
            if (confirm('确定要借阅这个档案吗？')) {
                showAlert('档案借阅申请已提交，等待审批', 'success');
                // TODO: 集成实际的借阅API
            }
        }

        // 归还档案
        function returnArchive(archiveId) {
            if (confirm('确定要归还这个档案吗？')) {
                showAlert('档案归还申请已提交', 'info');
                // TODO: 集成实际的归还API
            }
        }

        // 显示文件版本
        function showFileVersions(archiveId) {
            showTab('version');
        }

        // 搜索档案
        function searchArchives() {
            const keyword = document.getElementById('archive-search')?.value?.trim();
            if (!keyword && !document.getElementById('category-filter')?.value && 
                !document.getElementById('status-filter')?.value && 
                !document.getElementById('security-filter')?.value) {
                showAlert('请输入搜索条件', 'warning');
                return;
            }
            filterArchives();
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('archive-search').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('security-filter').value = '';
        }

        // 编辑档案
        function editArchive(archiveId) {
            alert('编辑档案: ' + archiveId);
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                window.location.href = '/login';
            }
        }

        // 加载生命周期记录
        async function loadLifecycleRecords() {
            try {
                const response = await fetch('/api/enhanced/lifecycle');
                if (response.ok) {
                    const data = await response.json();
                    displayLifecycleRecords(data.items || getMockLifecycleRecords());
                } else {
                    displayLifecycleRecords(getMockLifecycleRecords());
                }
            } catch (error) {
                console.error('加载生命周期记录失败:', error);
                displayLifecycleRecords(getMockLifecycleRecords());
            }
        }

        // 显示生命周期记录
        function displayLifecycleRecords(records) {
            const tbody = document.querySelector('#lifecycle-panel tbody');
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.archive_title}</td>
                    <td>${record.action_type}</td>
                    <td>${record.action_time}</td>
                    <td>${record.user_name}</td>
                    <td>${record.description || ''}</td>
                    <td>${record.status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 获取模拟生命周期记录
        function getMockLifecycleRecords() {
            return [
                {
                    id: '1',
                    archive_id: '1',
                    archive_title: '2023年度财务报告',
                    action_type: '创建',
                    action_time: '2023-12-31 10:30',
                    user_name: '张财务',
                    description: '创建档案记录',
                    status: '已完成'
                },
                {
                    id: '2',
                    archive_id: '2',
                    archive_title: '办公用品采购合同',
                    action_type: '借阅',
                    action_time: '2023-12-01 14:20',
                    user_name: '张三',
                    description: '借阅用于项目参考',
                    status: '进行中'
                }
            ];
        }

        // 加载分类数据
        async function loadCategories() {
            try {
                const response = await fetch('/api/enhanced/categories');
                if (response.ok) {
                    const data = await response.json();
                    const categories = data.items || getMockCategories();
                    displayCategories(categories);
                    renderCategoryTree(categories);
                    updateCategoryStats(categories);
                } else {
                    const mockData = getMockCategories();
                    displayCategories(mockData);
                    renderCategoryTree(mockData);
                    updateCategoryStats(mockData);
                }
            } catch (error) {
                console.error('加载分类数据失败:', error);
                const mockData = getMockCategories();
                displayCategories(mockData);
                renderCategoryTree(mockData);
                updateCategoryStats(mockData);
            }
        }

        // 显示分类列表
        function displayCategories(categories) {
            const tbody = document.querySelector('#category-list tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            categories.forEach(category => {
                const row = document.createElement('tr');
                const hasParent = category.parent_id && category.parent_id !== '';
                row.innerHTML = `
                    <td>${category.name}</td>
                    <td><span class="badge bg-secondary">${category.code}</span></td>
                    <td><span class="badge ${category.level === 1 ? 'bg-primary' : category.level === 2 ? 'bg-info' : 'bg-success'}">${category.level}级</span></td>
                    <td><span class="badge bg-warning">${category.archive_count || 0}</span></td>
                    <td>${category.created_at || ''}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${category.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="viewCategoryDetails('${category.id}')" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 渲染分类树形结构
        function renderCategoryTree(categories) {
            const treeContainer = document.getElementById('category-tree-container');
            if (!treeContainer) return;
            
            const treeData = buildTreeData(categories);
            treeContainer.innerHTML = renderTreeNodes(treeData, 0);
        }

        // 构建树形数据结构
        function buildTreeData(categories) {
            const tree = {};
            const roots = [];
            
            // 初始化所有节点
            categories.forEach(category => {
                tree[category.id] = {
                    ...category,
                    children: []
                };
            });
            
            // 构建父子关系
            categories.forEach(category => {
                if (category.parent_id && tree[category.parent_id]) {
                    tree[category.parent_id].children.push(tree[category.id]);
                } else {
                    roots.push(tree[category.id]);
                }
            });
            
            return roots;
        }

        // 渲染树形节点
        function renderTreeNodes(nodes, level) {
            if (!nodes || nodes.length === 0) return '';
            
            let html = '<div class="tree-children" style="margin-left: ' + (level * 20) + 'px;">';
            
            nodes.forEach(node => {
                html += `
                    <div class="tree-node" data-category-id="${node.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas ${node.children && node.children.length > 0 ? 'fa-folder' : 'fa-file'} me-2"></i>
                                <strong>${node.name}</strong>
                                <small class="text-muted ms-2">(${node.code})</small>
                                <span class="badge bg-primary ms-2">${node.archive_count || 0}</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); addSubCategory('${node.id}')" title="添加子分类">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editCategory('${node.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteCategory('${node.id}')" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                if (node.children && node.children.length > 0) {
                    html += renderTreeNodes(node.children, level + 1);
                }
            });
            
            html += '</div>';
            return html;
        }

        // 切换分类节点展开/收起
        function toggleCategoryNode(categoryId) {
            const node = document.querySelector(`[data-category-id="${categoryId}"]`);
            // 这里可以实现节点的展开/收起逻辑
        }

        // 更新分类统计数据
        function updateCategoryStats(categories) {
            const totalCategories = categories.length;
            const rootCategories = categories.filter(c => !c.parent_id || c.parent_id === '').length;
            const subCategories = categories.filter(c => c.parent_id && c.parent_id !== '').length;
            const activeCategories = categories.filter(c => (c.archive_count || 0) > 0).length;
            
            const totalElement = document.getElementById('total-categories');
            const rootElement = document.getElementById('root-categories');
            const subElement = document.getElementById('sub-categories');
            const activeElement = document.getElementById('active-categories');
            
            if (totalElement) totalElement.textContent = totalCategories;
            if (rootElement) rootElement.textContent = rootCategories;
            if (subElement) subElement.textContent = subCategories;
            if (activeElement) activeElement.textContent = activeCategories;
            
            // 更新图表
            renderCategoryCharts(categories);
        }

        // 渲染分类图表
        function renderCategoryCharts(categories) {
            // 分类级别分布图
            const levelChart = document.getElementById('category-level-chart');
            if (levelChart) {
                const levelData = {};
                categories.forEach(cat => {
                    levelData[}}`${cat.level}级`] = (levelData[`${cat.level`] || 0) + 1;
                });
                
                // 这里可以集成Chart.js或其他图表库来显示数据
                levelChart.innerHTML = createSimpleBarChart(levelData);
            }
            
            // 档案数量分布图
            const archiveChart = document.getElementById('category-archive-chart');
            if (archiveChart) {
                const archiveData = {};
                categories.forEach(cat => {
                    const count = cat.archive_count || 0;
                    const range = count === 0 ? '0个' : count <= 10 ? '1-10个' : count <= 50 ? '11-50个' : '50+个';
                    archiveData[range] = (archiveData[range] || 0) + 1;
                });
                
                archiveChart.innerHTML = createSimpleBarChart(archiveData);
            }
            
            // 分类层级关系图
            const hierarchyChart = document.getElementById('category-hierarchy-chart');
            if (hierarchyChart) {
                hierarchyChart.innerHTML = createHierarchyChart(categories);
            }
        }

        // 创建简单柱状图
        function createSimpleBarChart(data) {
            const maxValue = Math.max(...Object.values(data));
            let html = '<div class="chart-container">';
            
            Object.entries(data).forEach(([label, value]) => {
                const percentage = (value / maxValue) * 100;
                html += ` `
                    <div class="chart-row mb-2">
                        <div class="chart-label">${label}</div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${value}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // 创建层级关系图
        function createHierarchyChart(categories) {
            const treeData = buildTreeData(categories);
            let html = '<div class="hierarchy-container">';
            
            function renderHierarchyLevel(nodes, level) {
                if (!nodes || nodes.length === 0) return '';
                
                html += `<div class="hierarchy-level mb-3`;
                nodes.forEach(node => {
                    html += ` `
                        <div class="hierarchy-node">
                            <div class="node-box ${level === 0 ? 'root' : level === 1 ? 'child' : 'grandchild'}">
                                <div class="node-title">${node.name}</div>
                                <div class="node-count">${node.archive_count || 0}个档案</div>
                            </div>
                            ${node.children && node.children.length > 0 ? renderHierarchyLevel(node.children, level + 1) : ''}
                        </div>
                  `;
                });
                html += </div>``;
            }
            
            renderHierarchyLevel(treeData, 0);
            html += '</div>';
            return html;
        }

        // 搜索分类
        function searchCategories() {
            const searchTerm = document.getElementById('category-search')?.value.toLowerCase() || '';
            const levelFilter = document.getElementById('level-filter')?.value || '';
            
            loadCategories().then(() => {
                // 这里可以实现搜索和筛选逻辑
            });
        }

        // 添加分类
        function addCategory() {
            // 显示添加分类模态框
            showCreateCategoryModal();
        }

        // 显示创建分类模态框
        function showCreateCategoryModal() {
            const modalHtml = ` `
                <div class="modal fade" id="createCategoryModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">添加新分类</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createCategoryForm">
                                    <div class="mb-3">
                                        <label class="form-label">分类名称</label>
                                        <input type="text" class="form-control" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">分类代码</label>
                                        <input type="text" class="form-control" name="code" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">上级分类</label>
                                        <select class="form-select" name="parent_id">
                                            <option value="">无（顶级分类）</option>
                                            <!-- 动态加载分类选项 -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">分类描述</label>
                                        <textarea class="form-control" name="description" rows="3"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveCategory()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
          `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('createCategoryModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 加载上级分类选项
            loadParentCategories();
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('createCategoryModal'));
            modal.show();
        }

        // 加载上级分类选项
        async function loadParentCategories() {
            try {
                const response = await fetch('/api/enhanced/categories');
                const data = await response.json();
                const categories = data.items || getMockCategories();
                const select = document.querySelector('#createCategoryForm select[name="parent_id"]');
                
                if (select) {
                    // 清空现有选项（保留第一个）
                    select.innerHTML = '<option value="">无（顶级分类）</option>';
                    
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = ` `${category.name} (${category.code`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载上级分类失败:', error);
            }
        }

        // 保存分类
        async function saveCategory() {
            const form = document.getElementById('createCategoryForm');
            const formData = new FormData(form);
            const categoryData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/enhanced/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });
                
                if (response.ok) {
                    showAlert('分类添加成功！', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createCategoryModal')).hide();
                    loadCategories(); // 重新加载分类数据
                } else {
                    showAlert('分类添加失败！', 'error');
                }
            } catch (error) {
                console.error('保存分类失败:', error);
                showAlert('保存失败，请重试！', 'error');
            }
        }

        // 编辑分类
        function editCategory(categoryId) {
            // 显示编辑分类模态框
            showEditCategoryModal(categoryId);
        }

        // 显示编辑分类模态框
        async function showEditCategoryModal(categoryId) {
            try {
                const response = await fetch(`(`/api/enhanced/categories/${categoryId}`);
                const category = await response.json();
                
                const modalHtml = `
                    <div class="modal fade" id="editCategoryModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">编辑分类</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editCategoryForm">
                                        <input type="hidden" name="id" value="${category.id}">
                                        <div class="mb-3">
                                            <label class="form-label">分类名称</label>
                                            <input type="text" class="form-control" name="name" value="${category.name}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">分类代码</label>
                                            <input type="text" class="form-control" name="code" value="${category.code}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">上级分类</label>
                                            <select class="form-select" name="parent_id">
                                                <option value="">无（顶级分类）</option>
                                                <!-- 动态加载分类选项 -->
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">分类描述</label>
                                            <textarea class="form-control" name="description" rows="3">${category.description || ''}</textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="updateCategory()">更新</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除已存在的模态框
                const existingModal = document.getElementById('editCategoryModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 加载上级分类选项
                await loadParentCategories();
                
                // 设置当前上级分类
                const select = document.querySelector('#editCategoryForm select[name="parent_id"]');
                if (select) {
                    select.value = category.parent_id || '';
                }
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
                modal.show();
                
            } catch (error) {
                console.error('加载分类详情失败:', error);
                showAlert('加载分类详情失败！', 'error');
            }
        }

        // 更新分类
        async function updateCategory() {
            const form = document.getElementById('editCategoryForm');
            const formData = new FormData(form);
            const categoryData = Object.fromEntries(formData);
            const categoryId = categoryData.id;
            
            try {
                const response = await fetch(`/api/enhanced/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });
                
                if (response.ok) {
                    showAlert('分类更新成功！', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
                    loadCategories(); // 重新加载分类数据
                } else {
                    showAlert('分类更新失败！', 'error');
                }
            } catch (error) {
                console.error('更新分类失败:', error);
                showAlert('更新失败，请重试！', 'error');
            }
        }

        // 删除分类
        function deleteCategory(categoryId) {
            if (confirm('确定要删除这个分类吗？删除后无法恢复！')) {
                performDeleteCategory(categoryId);
            }
        }

        // 执行删除分类
        async function performDeleteCategory(categoryId) {
            try {
                const response = await fetch(`/api/enhanced/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('分类删除成功！', 'success');
                    loadCategories(); // 重新加载分类数据
                } else {
                    showAlert('分类删除失败！', 'error');
                }
            } catch (error) {
                console.error('删除分类失败:', error);
                showAlert('删除失败，请重试！', 'error');
            }
        }

        // 查看分类详情
        function viewCategoryDetails(categoryId) {
            // 显示分类详情模态框
            showCategoryDetailsModal(categoryId);
        }

        // 显示分类详情模态框
        async function showCategoryDetailsModal(categoryId) {
            try {
                const response = await fetch(`/api/enhanced/categories/${categoryId}`);
                const category = await response.json();
                
                const modalHtml = `
                    <div class="modal fade" id="categoryDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">分类详情</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>基本信息</h6>
                                            <table class="table table-sm">
                                                <tr><td>分类名称:</td><td>${category.name}</td></tr>
                                                <tr><td>分类代码:</td><td>${category.code}</td></tr>
                                                <tr><td>分类级别:</td><td>${category.level}级</td></tr>
                                                <tr><td>档案数量:</td><td>${category.archive_count || 0}个</td></tr>
                                                <tr><td>创建时间:</td><td>${category.created_at || ''}</td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>分类统计</h6>
                                            <div class="stats-small">
                                                <div class="stat-item">
                                                    <span class="stat-label">本月新增档案:</span>
                                                    <span class="stat-value">0</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-label">本月访问次数:</span>
                                                    <span class="stat-value">0</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-label">子分类数量:</span>
                                                    <span class="stat-value">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    <button type="button" class="btn btn-primary" onclick="editCategory('${categoryId}')">编辑</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除已存在的模态框
                const existingModal = document.getElementById('categoryDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 添加新模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('categoryDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('加载分类详情失败:', error);
                showAlert('加载分类详情失败！', 'error');
            }
        }

        // 添加子分类
        function addSubCategory(parentId) {
            showCreateCategoryModal();
            // 设置上级分类
            setTimeout(() => {
                const select = document.querySelector('#createCategoryForm select[name="parent_id"]');
                if (select) {
                    select.value = parentId;
                }
            }, 100);
        }

        // 获取模拟分类数据
        function getMockCategories() {
            return [
                {
                    id: '1',
                    name: '财务报告',
                    code: 'financial_reports',
                    level: 1,
                    archive_count: 25,
                    created_at: '2023-01-01',
                    description: '企业财务报告相关文件'
                },
                {
                    id: '2',
                    name: '季度财务报告',
                    code: 'quarterly_reports',
                    level: 2,
                    parent_id: '1',
                    archive_count: 8,
                    created_at: '2023-01-01',
                    description: '季度财务汇总报告'
                },
                {
                    id: '3',
                    name: '年度财务报告',
                    code: 'annual_reports',
                    level: 2,
                    parent_id: '1',
                    archive_count: 5,
                    created_at: '2023-01-01',
                    description: '年度财务总结报告'
                },
                {
                    id: '4',
                    name: '合同协议',
                    code: 'contracts',
                    level: 1,
                    archive_count: 18,
                    created_at: '2023-01-02',
                    description: '各类合同协议文件'
                },
                {
                    id: '5',
                    name: '采购合同',
                    code: 'purchase_contracts',
                    level: 2,
                    parent_id: '4',
                    archive_count: 12,
                    created_at: '2023-01-02',
                    description: '供应商采购合同'
                },
                {
                    id: '6',
                    name: '销售合同',
                    code: 'sales_contracts',
                    level: 2,
                    parent_id: '4',
                    archive_count: 6,
                    created_at: '2023-01-02',
                    description: '客户销售合同'
                },
                {
                    id: '7',
                    name: '发票凭证',
                    code: 'invoices',
                    level: 1,
                    archive_count: 45,
                    created_at: '2023-01-03',
                    description: '各类发票和财务凭证'
                },
                {
                    id: '8',
                    name: '增值税发票',
                    code: 'vat_invoices',
                    level: 2,
                    parent_id: '7',
                    archive_count: 30,
                    created_at: '2023-01-03',
                    description: '增值税专用发票'
                },
                {
                    id: '9',
                    name: '合规文件',
                    code: 'compliance',
                    level: 1,
                    archive_count: 12,
                    created_at: '2023-01-04',
                    description: '企业合规相关文件'
                },
                {
                    id: '10',
                    name: '审计报告',
                    code: 'audit_reports',
                    level: 2,
                    parent_id: '9',
                    archive_count: 8,
                    created_at: '2023-01-04',
                    description: '内外部审计报告'
                }
            ];
        }

        // 加载借阅记录
        async function loadBorrowRecords() {
            try {
                const response = await fetch('/api/enhanced/borrow');
                if (response.ok) {
                    const data = await response.json();
                    const records = data.items || getMockBorrowRecords();
                    displayBorrowRecords(records);
                    updateBorrowStats(records);
                } else {
                    const records = getMockBorrowRecords();
                    displayBorrowRecords(records);
                    updateBorrowStats(records);
                }
            } catch (error) {
                console.error('加载借阅记录失败:', error);
                const records = getMockBorrowRecords();
                displayBorrowRecords(records);
                updateBorrowStats(records);
            }
        }

        // 显示借阅记录
        function displayBorrowRecords(records) {
            const tbody = document.querySelector('#borrow-records-table tbody');
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const statusClass = record.status === '借出中' ? 'warning' : 'success';
                const isOverdue = record.status === '借出中' && new Date(record.due_date) < new Date();
                const overdueClass = isOverdue ? 'danger' : '';
                
                const row = document.createElement('tr');
                row.`
                    <td>${record.archive_title}</td>
                    <td>${record.borrower_name}</td>
                    <td>${record.department || '未设置'}</td>
                    <td>${record.borrow_date}</td>
                    <td>${record.due_date}</td>
                    <td>${record.return_date || '-'}</td>
                    <td>
                        <span class="badge bg-${statusClass} ${overdueClass}">${record.status}</span>
                        ${isOverdue ? '<small class="text-danger">(超期)</small>' : ''}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="viewBorrowDetail('${record.id}')" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="editBorrowRecord('${record.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${}}
                            <button class="btn btn-outline-danger" onclick="deleteBorrowRecord('${record.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `           `;
                tbody.appendChild(row);
            });
        }

        // 更新借阅统计
        function updateBorrowStats(records) {
            const total = records.length;
            const borrowed = records.filter(r => r.status === '借出中').length;
            const overdue = records.filter(r => r.status === '借出中' && new Date(r.due_date) < new Date()).length;
            const returned = records.filter(r => r.status === '已归还').length;
            
            document.getElementById('total-borrows').textContent = total;
            document.getElementById('current-borrows').textContent = borrowed;
            document.getElementById('overdue-borrows').textContent = overdue;
            document.getElementById('returned-borrows').textContent = returned;
        }

        // 搜索借阅记录
        function searchBorrowRecords() {
            const searchTerm = document.getElementById('borrow-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const borrowerFilter = document.getElementById('borrower-filter').value;
            
            let filtered = getMockBorrowRecords();
            
            // 搜索过滤
            if (searchTerm) {
                filtered = filtered.filter(record => 
                    record.archive_title.toLowerCase().includes(searchTerm) ||
                    record.borrower_name.toLowerCase().includes(searchTerm)
                );
            }
            
            // 状态过滤
            if (statusFilter) {
                filtered = filtered.filter(record => record.status === statusFilter);
            }
            
            // 借阅人过滤
            if (borrowerFilter) {
                filtered = filtered.filter(record => record.borrower_name === borrowerFilter);
            }
            
            displayBorrowRecords(filtered);
            updateBorrowStats(filtered);
        }

        // 借阅申请
        function applyForBorrow(archiveId) {
            const modal = new bootstrap.Modal(document.getElementById('borrowApplicationModal'));
            document.getElementById('application-archive-id').value = archiveId;
            modal.show();
        }

        // 确认借阅申请
        function confirmBorrowApplication() {
            const formData = {
                archive_id: document.getElementById('application-archive-id').value,
                borrower_name: document.getElementById('application-borrower-name').value,
                department: document.getElementById('application-department').value,
                purpose: document.getElementById('application-purpose').value,
                due_date: document.getElementById('application-due-date').value
            };
            
            // 表单验证
            if (!formData.borrower_name || !formData.department || !formData.purpose || !formData.due_date) {
                showAlert('请填写完整的借阅申请信息', 'warning');
                return;
            }
            
            // TODO: 集成实际的借阅API
            showAlert('借阅申请已提交，请等待审批', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('borrowApplicationModal'));
            modal.hide();
            
            // 重新加载数据
            loadBorrowRecords();
        }

        // 归还档案
        function returnBorrow(recordId) {
            if (confirm('确认要归还这个档案吗？')) {
                // TODO: 集成实际的归还API
                showAlert('档案已成功归还', 'success');
                loadBorrowRecords();
            }
        }

        // 查看借阅详情
        function viewBorrowDetail(recordId) {
            const record = getMockBorrowRecords().find(r => r.id === recordId);
            if (record) {
                alert(`借阅详情:\n档案: ${record.archive_title}\n借阅人: ${record.borrower_name}\n部门: ${record.department}\n借阅日期: ${record.borrow_date}\n应还日期: ${record.due_date}\n状态: ${record.status}`);
            }
        }

        // 编辑借阅记录
        function editBorrowRecord(recordId) {
            const record = getMockBorrowRecords().find(r => r.id === recordId);
            if (record) {
                alert(`编辑借阅记录: ${record.archive_title}`);
                // 这里可以打开编辑模态框
            }
        }

        // 删除借阅记录
        function deleteBorrowRecord(recordId) {
            if (confirm('确认要删除这条借阅记录吗？')) {
                // TODO: 集成实际的删除API
                showAlert('借阅记录已删除', 'success');
                loadBorrowRecords();
            }
        }

        // 获取模拟借阅记录
        function getMockBorrowRecords() {
            return [
                {
                    id: '1',
                    archive_id: '2',
                    archive_title: '办公用品采购合同',
                    borrower_name: '张三',
                    department: '行政部门',
                    borrow_date: '2023-12-01',
                    due_date: '2023-12-31',
                    return_date: null,
                    status: '借出中'
                },
                {
                    id: '2',
                    archive_id: '1',
                    archive_title: '2023年度财务报告',
                    borrower_name: '李四',
                    department: '财务部',
                    borrow_date: '2023-11-15',
                    due_date: '2023-12-15',
                    return_date: '2023-12-10',
                    status: '已归还'
                },
                {
                    id: '3',
                    archive_id: '3',
                    archive_title: '员工工资表',
                    borrower_name: '王五',
                    department: '人事部',
                    borrow_date: '2023-10-01',
                    due_date: '2023-10-31',
                    return_date: null,
                    status: '借出中'
                },
                {
                    id: '4',
                    archive_id: '4',
                    archive_title: '税务申报表',
                    borrower_name: '赵六',
                    department: '财务部',
                    borrow_date: '2023-11-20',
                    due_date: '2023-12-05',
                    return_date: '2023-12-08',
                    status: '已归还'
                },
                {
                    id: '5',
                    archive_id: '5',
                    archive_title: '发票存根',
                    borrower_name: '孙七',
                    department: '会计部',
                    borrow_date: '2023-11-25',
                    due_date: '2023-12-01',
                    return_date: null,
                    status: '借出中'
                }
            ];
        }

        // 加载版本记录
        async function loadVersionRecords() {
            try {
                const response = await fetch('/api/enhanced/version');
                let records = getMockVersionRecords();
                
                if (response.ok) {
                    const data = await response.json();
                    records = data.items || records;
                }
                
                displayVersionRecords(records);
                updateVersionStats(records);
            } catch (error) {
                console.error('加载版本记录失败:', error);
                const records = getMockVersionRecords();
                displayVersionRecords(records);
                updateVersionStats(records);
            }
        }

        // 显示版本记录
        function displayVersionRecords(records) {
            const tbody = document.querySelector('#version-panel tbody');
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${record.archive_title}</strong>
                        <br><small class="text-muted">ID: ${record.archive_id}</small>
                    </td>
                    <td>
                        <span class="badge ${record.version_type === 'current' ? 'bg-success' : 'bg-secondary'}">${record.version}</span>
                        <br><small class="text-muted">${record.version_type === 'current' ? '当前版本' : '历史版本'}</small>
                    </td>
                    <td>
                        <i class="fas fa-file-${getFileIcon(record.file_name)} me-1"></i>
                        ${record.file_name}
                    </td>
                    <td>${formatFileSize(record.file_size)}</td>
                    <td>
                        ${formatDateTime(record.created_at)}
                        <br><small class="text-muted">${getRelativeTime(record.created_at)}</small>
                    </td>
                    <td>
                        <i class="fas fa-user me-1"></i>
                        ${record.created_by}
                    </td>
                    <td>
                        <span class="text-truncate" style="max-width: 200px;" title="${record.change_description}">${record.change_description}</span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadVersion('${record.id}')" title="下载版本">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="viewVersionDetail('${record.id}')" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="compareVersions('${record.id}')" title="版本对比">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editVersion('${record.id}')" title="编辑版本">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteVersion('${record.id}')" title="删除版本">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 更新档案筛选器
            updateArchiveFilter(records);
        }

        // 获取模拟版本记录
        function getMockVersionRecords() {
            return [
                {
                    id: '1',
                    archive_id: '1',
                    archive_title: '2023年度财务报告',
                    version: 'v1.2',
                    version_type: 'current',
                    file_name: 'annual_report_2023_v1.2.pdf',
                    file_size: 2560,
                    created_at: '2023-12-31',
                    created_by: '张财务',
                    change_description: '修正财务数据错误'
                },
                {
                    id: '2',
                    archive_id: '1',
                    archive_title: '2023年度财务报告',
                    version: 'v1.1',
                    version_type: 'historical',
                    file_name: 'annual_report_2023_v1.1.pdf',
                    file_size: 2530,
                    created_at: '2023-12-30',
                    created_by: '张财务',
                    change_description: '添加图表内容'
                },
                {
                    id: '3',
                    archive_id: '2',
                    archive_title: '办公用品采购合同',
                    version: 'v2.1',
                    version_type: 'current',
                    file_name: 'office_supplies_contract_v2.1.docx',
                    file_size: 1280,
                    created_at: '2023-11-15',
                    created_by: '李采购',
                    change_description: '增加供应商信息条款'
                },
                {
                    id: '4',
                    archive_id: '3',
                    archive_title: '员工工资单模板',
                    version: 'v1.3',
                    version_type: 'current',
                    file_name: 'salary_template_v1.3.xlsx',
                    file_size: 512,
                    created_at: '2024-01-05',
                    created_by: '王人事',
                    change_description: '更新个税计算公式'
                },
                {
                    id: '5',
                    archive_id: '3',
                    archive_title: '员工工资单模板',
                    version: 'v1.2',
                    version_type: 'historical',
                    file_name: 'salary_template_v1.2.xlsx',
                    file_size: 488,
                    created_at: '2023-12-20',
                    created_by: '王人事',
                    change_description: '优化表格格式'
                },
                {
                    id: '6',
                    archive_id: '4',
                    archive_title: '税务申报材料',
                    version: 'v3.0',
                    version_type: 'current',
                    file_name: 'tax_declaration_v3.0.pdf',
                    file_size: 3840,
                    created_at: '2024-01-10',
                    created_by: '陈会计',
                    change_description: '年度税务汇算清缴版本'
                },
                {
                    id: '7',
                    archive_id: '4',
                    archive_title: '税务申报材料',
                    version: 'v2.5',
                    version_type: 'historical',
                    file_name: 'tax_declaration_v2.5.pdf',
                    file_size: 3650,
                    created_at: '2023-10-30',
                    created_by: '陈会计',
                    change_description: '季度申报调整'
                },
                {
                    id: '8',
                    archive_id: '5',
                    archive_title: '固定资产清单',
                    version: 'v1.1',
                    version_type: 'current',
                    file_name: 'fixed_assets_list_v1.1.xlsx',
                    file_size: 2048,
                    created_at: '2023-09-15',
                    created_by: '赵管理',
                    change_description: '新增设备资产记录'
                }
            ];
        }

        // 更新版本统计数据
        function updateVersionStats(records) {
            const totalVersions = records.length;
            const currentVersions = records.filter(r => r.version_type === 'current').length;
            const historicalVersions = records.filter(r => r.version_type === 'historical').length;
            const uniqueArchives = new Set(records.map(r => r.archive_id)).size;
            
            document.getElementById('total-versions').textContent = totalVersions;
            document.getElementById('current-versions').textContent = currentVersions;
            document.getElementById('historical-versions').textContent = historicalVersions;
            document.getElementById('archive-count').textContent = uniqueArchives;
        }

        // 更新档案筛选器
        function updateArchiveFilter(records) {
            const filter = document.getElementById('archive-filter');
            const uniqueArchives = [...new Set(records.map(r => ({ id: r.archive_id, title: r.archive_title })))];
            
            // 清除除第一个选项外的所有选项
            while (filter.children.length > 1) {
                filter.removeChild(filter.lastChild);
            }
            
            // 添加档案选项
            uniqueArchives.forEach(archive => {
                const option = document.createElement('option');
                option.value = archive.id;
                option.te`${archive.title} (ID: ${archive.id`{archive.id`;
                filter.appendChild(option);
            });
        }

        // 搜索和筛选版本记录
        function searchVersionRecords() {
            const searchTerm = document.getElementById('version-search').value.toLowerCase();
            const archiveFilter = document.getElementById('archive-filter').value;
            const versionFilter = document.getElementById('version-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            let filteredRecords = getMockVersionRecords();
            
            // 文本搜索
            if (searchTerm) {
                filteredRecords = filteredRecords.filter(record => 
                    record.archive_title.toLowerCase().includes(searchTerm) ||
                    record.file_name.toLowerCase().includes(searchTerm) ||
                    record.created_by.toLowerCase().includes(searchTerm) ||
                    record.change_description.toLowerCase().includes(searchTerm)
                );
            }
            
            // 档案筛选
            if (archiveFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.archive_id === archiveFilter
                );
            }
            
            // 版本类型筛选
            if (versionFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.version_type === versionFilter
                );
            }
            
            // 日期筛选
            if (dateFilter) {
                const now = new Date();
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.created_at);
                    switch (dateFilter) {
                        case 'today':
                            return recordDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return recordDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            return recordDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            displayVersionRecords(filteredRecords);
            updateVersionStats(filteredRecords);
        }

        // 重置筛选器
        function resetVersionFilters() {
            document.getElementById('version-search').value = '';
            document.getElementById('archive-filter').value = '';
            document.getElementById('version-filter').value = '';
            document.getElementById('date-filter').value = '';
            
            const records = getMockVersionRecords();
            displayVersionRecords(records);
            updateVersionStats(records);
        }

        // 新建版本
        function createNewVersion() {
            // 创建模态框显示新建版本表单
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = ` `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>新建档案版本
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="create-version-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">选择档案</label>
                                            <select class="form-select" id="new-version-archive" required>
                                                <option value="">请选择档案</option>
                                                ${${1}}">${a.title}</optio`
                                                ).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">新版本号</label>
                                            <input type="text" class="form-control" id="new-version-number" placeholder="例如: v2.0" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">上传文件</label>
                                    <input type="file" class="form-control" id="new-version-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">变更说明</label>
                                    <textarea class="form-control" id="new-version-description" rows="3" placeholder="请详细描述本次版本变更内容..." required></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="confirmCreateVersion()">
                                <i class="fas fa-save me-1"></i>创建版本
                            </button>
                        </div>
                    </div>
                </div>
            ` `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // 模态框关闭时移除DOM元素
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modal);
            });
        }

        // 确认创建版本
        function confirmCreateVersion() {
            const archiveId = document.getElementById('new-version-archive').value;
            const versionNumber = document.getElementById('new-version-number').value;
            const fileInput = document.getElementById('new-version-file');
            const description = document.getElementById('new-version-description').value;
            
            if (!archiveId || !versionNumber || !fileInput.files.length || !description) {
                alert('请填写所有必填字段');
                return;
            }
            
            // 模拟创建版本
            const newVersion = {
                id: Date.now().toString(),
                archive_id: archiveId,
                archive_title: getMockVersionRecords().find(r => r.archive_id === archiveId)?.archive_title || '未知档案',
                version: versionNumber,
                version_type: 'current',
                file_name: fileInput.files[0].name,
                file_size: Math.floor(Math.random() * 5000) + 1000,
                created_at: new Date().toISOString().split('T')[0],
                created_by: '当前用户',
                change_description: description
            };
            
            // 更新模拟数据（这里只是前端演示）
            const records = getMockVersionRecords();
            records.push(newVersion);
            
            // 将更新的数据保存到全局变量（实际项目中应该调用API）
            window.versionRecords = records;
            
            // 关闭模态框并刷新显示
            const modals = document.querySelectorAll('.modal');
            modals.forEach(m => {
                const modal = bootstrap.Modal.getInstance(m);
                if (modal) modal.hide();
            });
            
            displayVersionRecords(records);
            updateVersionStats(records);
            
            alert(`版本 ${versionNumber} 创建成功！`);
        }

        // 查看版本详情
        function viewVersionDetail(versionId) {
            const records = getMockVersionRecords();
            const record = records.find(r => r.id === versionId);
            
            if (!record) {
                alert('版本记录不存在');
                return;
            }
            
            // 创建详情模态框
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-info-circle me-2"></i>版本详情
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>基本信息</h6>
                                    <table class="table table-borderless">
                                        <tr><td><strong>档案名称:</strong></td><td>${record.archive_title}</td></tr>
                                        <tr><td><strong>版本号:</strong></td><td><span class="badge bg-primary">${record.version}</span></td></tr>
                                        <tr><td><strong>文件名称:</strong></td><td>${record.file_name}</td></tr>
                                        <tr><td><strong>文件大小:</strong></td><td>${formatFileSize(record.file_size)}</td></tr>
                                        <tr><td><strong>创建时间:</strong></td><td>${formatDateTime(record.created_at)}</td></tr>
                                        <tr><td><strong>创建人:</strong></td><td>${record.created_by}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>变更信息</h6>
                                    <div class="p-3 bg-light rounded">
                                        <p><strong>变更说明:</strong></p>
                                        <p>${record.change_description}</p>
                                        <p><strong>版本类型:</strong> 
                                            <span class="badge ${record.version_type === 'current' ? 'bg-success' : 'bg-secondary'}">
                                                ${record.version_type === 'current' ? '当前版本' : '历史版本'}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" onclick="downloadVersion('${versionId}')">
                                <i class="fas fa-download me-1"></i>下载文件
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modal);
            });
        }

        // 编辑版本
        function editVersion(versionId) {
            const records = getMockVersionRecords();
            const record = records.find(r => r.id === versionId);
            
            if (!record) {
                alert('版本记录不存在');
                return;
            }
            
            // 创建编辑模态框
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>编辑版本
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-version-form">
                                <div class="mb-3">
                                    <label class="form-label">变更说明</label>
                                    <textarea class="form-control" id="edit-version-description" rows="4">${record.change_description}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">版本类型</label>
                                    <select class="form-select" id="edit-version-type">
                                        <option value="current" ${record.version_type === 'current' ? 'selected' : ''}>当前版本</option>
                                        <option value="historical" ${record.version_type === 'historical' ? 'selected' : ''}>历史版本</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="confirmEditVersion('${versionId}')">
                                <i class="fas fa-save me-1"></i>保存修改
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modal);
            });
        }

        // 确认编辑版本
        function confirmEditVersion(versionId) {
            const newDescription = document.getElementById('edit-version-description').value;
            const newType = document.getElementById('edit-version-type').value;
            
            if (!newDescription) {
                alert('请填写变更说明');
                return;
            }
            
            // 更新模拟数据
            const records = getMockVersionRecords();
            const recordIndex = records.findIndex(r => r.id === versionId);
            
            if (recordIndex !== -1) {
                records[recordIndex].change_description = newDescription;
                records[recordIndex].version_type = newType;
                
                // 将更新的数据保存到全局变量
                window.versionRecords = records;
                
                // 关闭模态框并刷新显示
                const modals = document.querySelectorAll('.modal');
                modals.forEach(m => {
                    const modal = bootstrap.Modal.getInstance(m);
                    if (modal) modal.hide();
                });
                
                displayVersionRecords(records);
                updateVersionStats(records);
                
                alert('版本信息更新成功！');
            }
        }

        // 删除版本
        function deleteVersion(versionId) {
            if (!confirm('确定要删除这个版本吗？此操作不可撤销。')) {
                return;
            }
            
            // 更新模拟数据
            const records = getMockVersionRecords();
            const filteredRecords = records.filter(r => r.id !== versionId);
            
            // 将更新的数据保存到全局变量
            window.versionRecords = filteredRecords;
            
            displayVersionRecords(filteredRecords);
            updateVersionStats(filteredRecords);
            
            alert('版本删除成功！');
        }

        // 版本对比
        function compareVersions(versionId) {
            const records = getMockVersionRecords();
            const currentRecord = records.find(r => r.id === versionId);
            
            if (!currentRecord) {
                alert('版本记录不存在');
                return;
            }
            
            // 查找同一档案的其他版本
            const otherVersions = records.filter(r => 
                r.archive_id === currentRecord.archive_id && r.id !== versionId
            ).slice(0, 2); // 最多显示2个其他版本
            
            if (otherVersions.length === 0) {
                alert('没有找到可对比的版本');
                return;
            }
            
            // 创建对比模态框
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-balance-scale me-2"></i>版本对比
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>对比项目</th>
                                            <th>${currentRecord.version}</th>
                                            ${${1}}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>文件名称</strong></td>
                                            <td>${currentRecord.file_name}</td>
                                            ${${1}}
                                        </tr>
                                        <tr>
                                            <td><strong>文件大小</strong></td>
                                            <td>${formatFileSize(currentRecord.file_size)}</td>
                                            ${${1}}
                                        </tr>
                                        <tr>
                                            <td><strong>创建时间</strong></td>
                                            <td>${formatDateTime(currentRecord.created_at)}</td>
                                            ${${1}}
                                        </tr>
                                        <tr>
                                            <td><strong>创建人</strong></td>
                                            <td>${currentRecord.created_by}</td>
                                            ${${1}}
                                        </tr>
                                        <tr>
                                            <td><strong>变更说明</strong></td>
                                            <td>${currentRecord.change_description}</td>
                                            ${${1}}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modal);
            });
        }

        // 全部版本对比
        function compareAllVersions() {
            const records = getMockVersionRecords();
            const archives = [...new Set(records.map(r => ({ id: r.archive_id, title: r.archive_title })))];
            
            if (archives.length === 0) {
                alert('没有找到可对比的档案');
                return;
            }
            
            // 创建档案选择模态框
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-balance-scale me-2"></i>选择要对比的档案
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">请选择档案:</label>
                                <select class="form-select" id="compare-archive-select">
                                    <option value="">请选择档案</option>
                                    ${${1}}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="confirmCompareArchive()">
                                <i class="fas fa-balance-scale me-1"></i>开始对比
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modal);
            });
        }

        // 确认对比档案
        function confirmCompareArchive() {
            const archiveId = document.getElementById('compare-archive-select').value;
            
            if (!archiveId) {
                alert('请选择要对比的档案');
                return;
            }
            
            const records = getMockVersionRecords();
            const archiveRecords = records.filter(r => r.archive_id === archiveId);
            
            if (archiveRecords.length < 2) {
                alert('该档案只有一个版本，无法进行对比');
                return;
            }
            
            // 关闭档案选择模态框
            const modals = document.querySelectorAll('.modal');
            modals.forEach(m => {
                const modal = bootstrap.Modal.getInstance(m);
                if (modal) modal.hide();
            });
            
            // 模拟对比操作（这里只显示提示）
            alert(`即将对比档案 "${archiveRecords[0].archive_title}" 的 ${archiveRecords.length} 个版本...`);
            
            // TODO: 打开详细的版本对比界面
        }

        // 下载版本
        function downloadVersion(versionId) {
            const records = getMockVersionRecords();
            const record = records.find(r => r.id === versionId);
            
            if (!record) {
                alert('版本记录不存在');
                return;
            }
            
            // 模拟下载
            const link = document.createElement('a');
            link.href = '#';
            link.download = record.file_name;
            
            // 触发下载
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`正在下载: ${record.file_name}`);
        }

        // 辅助函数：根据文件扩展名获取图标
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf':
                    return 'pdf';
                case 'doc':
                case 'docx':
                    return 'word';
                case 'xls':
                case 'xlsx':
                    return 'excel';
                case 'txt':
                    return 'alt';
                default:
                    return 'file';
            }
        }

        // 辅助函数：格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 辅助函数：格式化日期时间
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 辅助函数：获取相对时间
        function getRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return '今天';
            if (days === 1) return '昨天';
            if (days < 7) return `${days}天前`;
            if (days < 30) return `${Math.floor(days / 7)}周前`;
            if (days < 365) return `${Math.floor(days / 30)}个月前`;
            return `${Math.floor(days / 365)}`;
        }

        // 加载审计日志
        async function loadAuditLogs() {
            try {
                const response = await fetch('/api/enhanced/audit');
                if (response.ok) {
                    const data = await response.json();
                    const records = data.items || getMockAuditLogs();
                    displayAuditLogs(records);
                    return records;
                } else {
                    const records = getMockAuditLogs();
                    displayAuditLogs(records);
                    return records;
                }
            } catch (error) {
                console.error('加载审计日志失败:', error);
                const records = getMockAuditLogs();
                displayAuditLogs(records);
                return records;
            }
        }

        // 显示审计日志
        function displayAuditLogs(logs) {
            const tbody = document.querySelector('#audit-table-body');
            tbody.innerHTML = '';
            
            logs.forEach(log => {
                const actionClass = {
                    '创建': 'success',
                    '修改': 'warning',
                    '删除': 'danger',
                    '查看': 'info',
                    '下载': 'secondary',
                    '借阅': 'primary',
                    '归还': 'info',
                    '审核': 'warning',
                    '系统': 'dark'
                }[log.action] || 'secondary';

                const resourceClass = {
                    '档案': 'primary',
                    '分类': 'secondary',
                    '借阅': 'info',
                    '版本': 'success',
                    '用户': 'warning',
                    '系统': 'dark'
                }[log.resource_type] || 'secondary';
                
                const row = document.createElement('tr');
                row.innerHTML = ` `
                    <td>
                        <input type="checkbox" class="audit-checkbox" value="${log.id}">
                    </td>
                    <td>
                        <small class="text-muted">${log.timestamp}</small>
                    </td>
                    <td>
                        <span class="fw-bold text-primary">${log.user_name}</span>
                    </td>
                    <td>
                        <span class="badge bg-${actionClass}">${log.action}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${resourceClass} me-2">${log.resource_type}</span>
                            <span class="text-truncate" style="max-width: 150px;" title="${log.resource_name}">${log.resource_name}</span>
                        </div>
                    </td>
                    <td>
                        <code class="small">${log.ip_address}</code>
                    </td>
                    <td>
                        <span class="text-truncate d-block" style="max-width: 200px;" title="${log.details}">${log.details}</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="viewAuditDetail('${log.id}')" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportAuditLog('${log.id}')" title="导出记录">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
              `;
                tbody.appendChild(row);
            });

            // 更新显示计数
            document.getElementById('audit-display-count').textContent = logs.length;
            
            // 更新统计数据
            updateAuditStats(logs);
        }

        // 获取模拟审计日志
        function getMockAuditLogs() {
            const currentDate = new Date();
            const logs = [];
            let id = 1;

            // 生成最近30天的审计日志
            for (let i = 0; i < 30; i++) {
                const logDate = new Date(currentDate.getTime() - i * 24 * 60 * 60 * 1000);
                
                // 每天生成1-5条记录
                const dailyLogs = Math.floor(Math.random() * 5) + 1;
                
                for (let j = 0; j < dailyLogs; j++) {
                    const actions = ['创建', '修改', '删除', '查看', '下载', '借阅', '归还', '审核'];
                    const resources = ['档案', '分类', '借阅', '版本', '用户'];
                    const users = ['admin', '张财务', '张三', '李四', '王五', '赵六'];
                    const resource_names = {
                        '档案': '2023年度财务报告|办公用品采购合同|员工工资单|项目验收报告|供应商合同|会议纪要|发票凭证|资产清单',
                        '分类': '财务类|合同类|人事类|项目类',
                        '借阅': '档案借阅记录|归还记录|续借记录',
                        '版本': 'v1.0|v1.1|v1.2|v2.0',
                        '用户': '用户管理|权限设置|角色配置'
                    };

                    const action = actions[Math.floor(Math.random() * actions.length)];
                    const resource = resources[Math.floor(Math.random() * resources.length)];
                    const user = users[Math.floor(Math.random() * users.length)];
                    const resourceNames = resource_names[resource].split('|');
                    const resource_name = resourceNames[Math.floor(Math.random() * resourceNames.length)];

                    // 根据操作类型生成不同详情
                    let details = '';
                    switch (action) {
                        case '创建':
                            details = ` `创建新的${resource}：${resource_name}`;
                            break;
                        case '修改':
                            details = `修改${resource}信息：${resource_name}`;
                            break;
                        case '删除':
                            details = `删除${resource}：${resource_name}`;
                            break;
                        case '查看':
                            details = `查看${resource}详情：${resource_name}`;
                            break;
                        case '下载':
                            details = `下载${resource}文件：${resource_name}`;
                            break;
                        case '借阅':
                            details = `借阅档案：${resource_name}`;
                            break;
                        case '归还':
                            details = `归还档案：${resource_name}`;
                            break;
                        case '审核':
                            details = `审核档案：${resource_name}`;
                            break;
                        default:
                            details = `${action}操作：${resource_name}`;
                    }

                    logs.push({
                        id: String(id++),
                        timestamp: logDate.toISOString().slice(0, 19).replace('T', ' ') + 
                                 ' ' + String(Math.floor(Math.random() * 24)).padStart(2, '0') + ':' +
                                 String(Math.floor(Math.random() * 60)).padStart(2, '0') + ':' +
                                 String(Math.floor(Math.random() * 60)).padStart(2, '0'),
                        user_name: user,
                        action: action,
                        resource_type: resource,
                        resource_name: resource_name,
                        `19`192.168.1.${Math.floor(Math.random() * 100) + 10}00) + 10`,
                        details: details,
                        user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    });
                }
            }

            // 添加一些重要的特定记录
            logs.unshift({
                id: String(id++),
                timestamp: '2023-12-31 23:59:59',
                user_name: '系统',
                ip_address: '192.168.1.1',
                action: '系统',
                resource_type: '系统',
                resource_name: '系统自动备份',
                details: '系统自动备份完成',
                user_agent: 'System'
            });

            logs.unshift({
                id: String(id++),
                timestamp: '2023-12-31 23:00:00',
                user_name: 'admin',
                ip_address: '192.168.1.100',
                action: '创建',
                resource_type: '档案',
                resource_name: '2023年度财务报告',
                details: '创建新的档案记录',
                user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            });

            logs.unshift({
                id: '1',
                timestamp: '2023-12-31 10:30:25',
                user_name: '张财务',
                ip_address: '192.168.1.100',
                action: '创建',
                resource_type: '档案',
                resource_name: '2023年度财务报告',
                details: '创建新的档案记录',
                user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            });

            logs.unshift({
                id: '2',
                timestamp: '2023-12-31 11:15:42',
                user_name: '张三',
                ip_address: '192.168.1.105',
                action: '借阅',
                resource_type: '档案',
                resource_name: '办公用品采购合同',
                details: '借阅档案用于项目参考',
                user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
            });

            return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // 更新审计统计
        function updateAuditStats(logs) {
            const totalLogs = logs.length;
            const createLogs = logs.filter(log => log.action === '创建').length;
            const modifyLogs = logs.filter(log => log.action === '修改').length;
            const deleteLogs = logs.filter(log => log.action === '删除').length;

            document.getElementById('total-logs').textContent = totalLogs;
            document.getElementById('create-logs').textContent = createLogs;
            document.getElementById('modify-logs').textContent = modifyLogs;
            document.getElementById('delete-logs').textContent = deleteLogs;
        }

        // 搜索审计日志
        function searchAuditLogs() {
            const searchTerm = document.getElementById('audit-search').value.toLowerCase();
            const allLogs = getMockAuditLogs();
            const filteredLogs = allLogs.filter(log => 
                log.user_name.toLowerCase().includes(searchTerm) ||
                log.action.toLowerCase().includes(searchTerm) ||
                log.resource_name.toLowerCase().includes(searchTerm) ||
                log.details.toLowerCase().includes(searchTerm)
            );
            displayAuditLogs(filteredLogs);
        }

        // 筛选审计日志
        function filterAuditLogs() {
            const actionFilter = document.getElementById('action-filter').value;
            const resourceFilter = document.getElementById('resource-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            let allLogs = getMockAuditLogs();

            // 按操作类型筛选
            if (actionFilter) {
                allLogs = allLogs.filter(log => log.action === actionFilter);
            }

            // 按资源类型筛选
            if (resourceFilter) {
                allLogs = allLogs.filter(log => log.resource_type === resourceFilter);
            }

            // 按时间范围筛选
            if (dateFilter) {
                const now = new Date();
                let startDate;
                switch (dateFilter) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'year':
                        startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        break;
                }
                if (startDate) {
                    allLogs = allLogs.filter(log => new Date(log.timestamp) >= startDate);
                }
            }

            displayAuditLogs(allLogs);
        }

        // 重置审计筛选器
        function resetAuditFilters() {
            document.getElementById('audit-search').value = '';
            document.getElementById('action-filter').value = '';
            document.getElementById('resource-filter').value = '';
            document.getElementById('date-filter').value = '';
            displayAuditLogs(getMockAuditLogs());
        }

        // 刷新审计日志
        function refreshAuditLogs() {
            loadAuditLogs().then(logs => {
                // 应用当前筛选条件
                filterAuditLogs();
            });
        }

        // 查看审计详情
        function viewAuditDetail(logId) {
            const logs = getMockAuditLogs();
            const log = logs.find(l => l.id === logId);
            
            if (log) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = ` `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">审计日志详情</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>ID:</strong> ${log.id}</p>
                                        <p><strong>时间戳:</strong> ${log.timestamp}</p>
                                        <p><strong>用户:</strong> ${log.user_name}</p>
                                        <p><strong>操作类型:</strong> <span class="badge bg-${log.action === '创建' ? 'success' : log.action === '修改' ? 'warning' : 'danger'}">${log.action}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>资源类型:</strong> ${log.resource_type}</p>
                                        <p><strong>资源名称:</strong> ${log.resource_name}</p>
                                        <p><strong>IP地址:</strong> <code>${log.ip_address}</code></p>
                                        <p><strong>用户代理:</strong> <small class="text-muted">${log.user_agent}</small></p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p><strong>操作详情:</strong></p>
                                    <div class="alert alert-info">${log.details}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            }
        }

        // 导出审计日志
        function exportAuditLog(logId) {
            const logs = getMockAuditLogs();
            const log = logs.find(l => l.id === logId);
            
            if (log) {
                const data = JSON.stringify(log, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit-log-${logId}.js`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // 导出所有审计日志
        function exportAuditLogs() {
            const allLogs = getMockAuditLogs();
            const data = JSON.stringify(allLogs, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = ` `audit-logs-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 生成审计报告
        function generateAuditReport() {
            const allLogs = getMockAuditLogs();
            const reportData = {
                generation_time: new Date().toISOString(),
                total_records: allLogs.length,
                action_summary: {},
                resource_summary: {},
                user_summary: {},
                daily_activity: {}
            };

            // 统计操作类型
            allLogs.forEach(log => {
                reportData.action_summary[log.action] = (reportData.action_summary[log.action] || 0) + 1;
                reportData.resource_summary[log.resource_type] = (reportData.resource_summary[log.resource_type] || 0) + 1;
                reportData.user_summary[log.user_name] = (reportData.user_summary[log.user_name] || 0) + 1;
                
                const date = log.timestamp.split(' ')[0];
                reportData.daily_activity[date] = (reportData.daily_activity[date] || 0) + 1;
            });

            const data = JSON.stringify(reportData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-report-${new Date().toISOString().split('T')[0]}.js`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 全选/取消全选
        function toggleAuditSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-audit');
            const checkboxes = document.querySelectorAll('.audit-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // 加载工作流记录
        async function loadWorkflowRecords() {
            try {
                const response = await fetch('/api/enhanced/workflow');
                if (response.ok) {
                    const data = await response.json();
                    displayWorkflowRecords(data.items || getMockWorkflowRecords());
                } else {
                    displayWorkflowRecords(getMockWorkflowRecords());
                }
            } catch (error) {
                console.error('加载工作流记录失败:', error);
                displayWorkflowRecords(getMockWorkflowRecords());
            }
        }

        // 显示工作流记录
        function displayWorkflowRecords(records) {
            const tbody = document.querySelector('#workflow-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const statusClass = {
                    'pending': 'warning',
                    'approved': 'success', 
                    'rejected': 'danger',
                    'in_progress': 'info',
                    'completed': 'secondary'
                }[record.status] || 'secondary';
                
                const priorityClass = {
                    'high': 'danger',
                    'medium': 'warning',
                    'low': 'info'
                }[record.priority] || 'secondary';
                
                const typeClass = {
                    'archive_creation': 'primary',
                    'archive_modification': 'warning',
                    'archive_deletion': 'danger',
                    'access_request': 'info'
                }[record.workflow_type] || 'secondary';
                
                const row = document.createElement('tr');
                row.innerHTML = ` `
 `
                    <td><input type="checkbox" class="workflow-checkbox" value="${record.id}"></td>
                    <td>${record.workflow_number}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">${record.archive_title}</h6>
                                <small class="text-muted">ID: ${record.archive_id}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <strong>${record.requester_name}</strong>
                            <br><small class="text-muted">${record.requester_dept}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${typeClass}">${getWorkflowTypeText(record.workflow_type)}</span>
                    </td>
                    <td>
                        <span class="badge bg-${priorityClass}">${getPriorityText(record.priority)}</span>
                    </td>
                    <td>
                        <span class="badge bg-${statusClass}">${getStatusText(record.status)}</span>
                    </td>
                    <td>
                        <div>
                            <div>${formatDateTime(record.created_at)}</div>
                            <small class="text-muted">${getTimeAgo(record.created_at)}</small>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewWorkflowDetail('${record.id}')" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${record.status === 'pending' ? }                              <button class="btn btn-sm btn-outline-danger" onclick="rejectWorkflow('${record.id}')" title="拒绝">
                                    <i class="fas fa-times"></i>
                                </button>
                            `
                            <button class="btn btn-sm btn-outline-secondary" onclick="editWorkflow('${record.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
              `;
                tbody.appendChild(row);
            });
            
            // 更新显示计数
            updateWorkflowDisplayCount(records.length);
            
            // 更新统计数据
            updateWorkflowStats(records);
        }

        // 获取模拟工作流记录
        function getMockWorkflowRecords() {
            const archiveTypes = ['财务报告', '合同协议', '发票凭证', '合规文件', '员工档案'];
            const departments = ['财务部', '人事部', '法务部', '销售部', '采购部'];
            const requesters = ['李财务', '王人事', '张法务', '刘销售', '陈采购', '赵经理'];
            const statuses = ['pending', 'approved', 'rejected', 'in_progress', 'completed'];
            const priorities = ['high', 'medium', 'low'];
            const workflowTypes = ['archive_creation', 'archive_modification', 'archive_deletion', 'access_request'];
            
            const records = [];
            const now = new Date();
            
            // 生成基础模拟数据
            for (let i = 1; i <= 25; i++) {
                const createdDate = new Date(now.getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const priority = priorities[Math.floor(Math.random() * priorities.length)];
                const workflowType = workflowTypes[Math.floor(Math.random() * workflowTypes.length)];
                const requester = requesters[Math.floor(Math.random() * requesters.length)];
                const dept = departments[Math.floor(Math.random() * departments.length)];
                const archiveType = archiveTypes[Math.floor(Math.random() * archiveTypes.length)];
                
                records.push({
                    id: i.toString(),
                    workflow_number: ` `WF-${String(i).padStart(4, '0')}`,
                    archive_id: `ARC-${String(1000 + i)}`,
                    archive_title: `${archiveType}文档${i}`,
                    workflow_type: workflowType,
                    requester_name: requester,
                    requester_dept: dept,
                    priority: priority,
                    status: status,
                    created_at: createdDate.toISOString().split('T')[0],
                    description: `针对${archiveType}的审核`
                });
            }
            
            // 添加一些重要的特定记录
            records.push(
                {
                    id: '26',
                    workflow_number: 'WF-0026',
                    archive_id: 'ARC-1026',
                    archive_title: '年度财务报表审核',
                    workflow_type: 'archive_creation',
                    requester_name: '李财务',
                    requester_dept: '财务部',
                    priority: 'high',
                    status: 'pending',
                    created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    description: '2023年度完整财务报表审核'
                },
                {
                    id: '27',
                    workflow_number: 'WF-0027',
                    archive_id: 'ARC-1027',
                    archive_title: '员工保密协议更新',
                    workflow_type: 'archive_modification',
                    requester_name: '王人事',
                    requester_dept: '人事部',
                    priority: 'medium',
                    status: 'in_progress',
                    created_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    description: '更新员工保密协议条款'
                },
                {
                    id: '28',
                    workflow_number: 'WF-0028',
                    archive_id: 'ARC-1028',
                    archive_title: '过期合同清理',
                    workflow_type: 'archive_deletion',
                    requester_name: '张法务',
                    requester_dept: '法务部',
                    priority: 'low',
                    status: 'approved',
                    created_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    description: '清理已过期的合同文件'
                }
            );
            
            // 按创建时间倒序排序
            return records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        // 工作流辅助函数
        function getWorkflowTypeText(type) {
            const typeMap = {
                'archive_creation': '档案创建',
                'archive_modification': '档案修改',
                'archive_deletion': '档案删除',
                'access_request': '访问请求'
            };
            return typeMap[type] || type;
        }

        function getPriorityText(priority) {
            const priorityMap = {
                'high': '高',
                'medium': '中',
                'low': '低'
            };
            return priorityMap[priority] || priority;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待审核',
                'approved': '已通过',
                'rejected': '已拒绝',
                'in_progress': '进行中',
                'completed': '已完成'
            };
            return statusMap[status] || status;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInMs = now - date;
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInDays === 0) {
                return '今天';
            } else if (diffInDays === 1) {
                return '昨天';
            } else if (diffInDays < 7) {
                return ` `${diffInDays}天前`;
            } else {
                return `${Math.floor(diffInDays / 7)}`;
            }
        }

        function updateWorkflowDisplayCount(count) {
            // 这里可以更新显示计数，如果有这样的元素的话
            // 工作流记录加载完成
        }

        function updateWorkflowStats(records) {
            const stats = {
                total: records.length,
                pending: 0,
                in_progress: 0,
                completed: 0
            };
            
            records.forEach(record => {
                switch (record.status) {
                    case 'pending':
                        stats.pending++;
                        break;
                    case 'in_progress':
                        stats.in_progress++;
                        break;
                    case 'approved':
                    case 'completed':
                        stats.completed++;
                        break;
                }
            });
            
            // 更新统计卡片
            const totalElement = document.getElementById('workflow-total');
            const pendingElement = document.getElementById('workflow-pending');
            const inProgressElement = document.getElementById('workflow-in-progress');
            const completedElement = document.getElementById('workflow-completed');
            
            if (totalElement) totalElement.textContent = stats.total;
            if (pendingElement) pendingElement.textContent = stats.pending;
            if (inProgressElement) inProgressElement.textContent = stats.in_progress;
            if (completedElement) completedElement.textContent = stats.completed;
        }

        // 工作流核心功能函数
        function startNewWorkflow() {
            // 显示新建工作流模态框
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = ` `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">新建工作流</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="new-workflow-form">
                                <div class="mb-3">
                                    <label class="form-label">档案标题</label>
                                    <input type="text" class="form-control" name="archive_title" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">流程类型</label>
                                    <select class="form-select" name="workflow_type" required>
                                        <option value="archive_creation">档案创建</option>
                                        <option value="archive_modification">档案修改</option>
                                        <option value="archive_deletion">档案删除</option>
                                        <option value="access_request">访问请求</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">优先级</label>
                                    <select class="form-select" name="priority" required>
                                        <option value="low">低</option>
                                        <option value="medium" selected>中</option>
                                        <option value="high">高</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">描述</label>
                                    <textarea class="form-control" name="description" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="submitNewWorkflow()">创建</button>
                        </div>
                    </div>
                </div>
          `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // 清理模态框
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function submitNewWorkflow() {
            const form = document.getElementById('new-workflow-form');
            const formData = new FormData(form);
            
            const newWorkflow = {
                id: Date.now().toString(),
                workflow_number: ` `WF-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
                archive_id: `AR`ARC-${String(1000 + Math.floor(Math.random() * 1000)}               archive_title: formData.get('archive_title'),
                workflow_type: formData.get('workflow_type'),
                requester_name: '当前用户',
                requester_dept: '当前部门',
                priority: formData.get('priority'),
                status: 'pending',
                created_at: new Date().toISOString().split('T')[0],
                description: formData.get('description')
            };
            
            // TODO: 调用API保存到后端
            
            // 关闭模态框并刷新列表
            const modal = document.querySelector('.modal.show');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
            }
            
            // 重新加载工作流列表
            loadWorkflowRecords();
            
            showAlert('工作流创建成功！', 'success');
        }

        function viewWorkflowDetail(workflowId) {
            // 获取工作流详情（这里使用模拟数据）
            const mockWorkflows = getMockWorkflowRecords();
            const workflow = mockWorkflows.find(w => w.id === workflowId);
            
            if (!workflow) {
                showAlert('工作流不存在！', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = ` `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">工作流详情 - ${workflow.workflow_number}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>基本信息</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>流程编号:</strong></td><td>${workflow.workflow_number}</td></tr>
                                        <tr><td><strong>档案标题:</strong></td><td>${workflow.archive_title}</td></tr>
                                        <tr><td><strong>档案ID:</strong></td><td>${workflow.archive_id}</td></tr>
                                        <tr><td><strong>申请人:</strong></td><td>${workflow.requester_name}</td></tr>
                                        <tr><td><strong>申请部门:</strong></td><td>${workflow.requester_dept}</td></tr>
                                        <tr><td><strong>流程类型:</strong></td><td>${getWorkflowTypeText(workflow.workflow_type)}</td></tr>
                                        <tr><td><strong>优先级:</strong></td><td>${getPriorityText(workflow.priority)}</td></tr>
                                        <tr><td><strong>当前状态:</strong></td><td>${getStatusText(workflow.status)}</td></tr>
                                        <tr><td><strong>创建时间:</strong></td><td>${formatDateTime(workflow.created_at)}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>流程图</h6>
                                    <div class="text-center p-4 border">
                                        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">流程图功能正在开发中</p>
                                        <small class="text-muted">将显示完整的工作流程步骤</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>描述</h6>
                                <p>${workflow.description || '无描述信息'}</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline-danger" onclick="rejectWorkflow('${workflowId}')">拒绝</button>
                            `
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function approveWorkflow(workflowId) {
            if (confirm('确定要批准这个工作流吗？')) {
                // TODO: 调用API更新状态
                updateWorkflowStatus(workflowId, 'approved');
                
                showAlert('工作流已批准！', 'success');
            }
        }

        function rejectWorkflow(workflowId) {
            const reason = prompt('请输入拒绝理由（可选）:');
            if (confirm('确定要拒绝这个工作流吗？')) {
                // TODO: 调用API更新状态
                updateWorkflowStatus(workflowId, 'rejected');
                
                showAlert('工作流已拒绝！', 'warning');
            }
        }

        function editWorkflow(workflowId) {
            showAlert('编辑功能正在开发中！', 'info');
        }

        function updateWorkflowStatus(workflowId, newStatus) {
            // 这里应该调用API更新状态，现在只更新本地显示
            loadWorkflowRecords();
        }

        function searchWorkflows() {
            const searchTerm = document.getElementById('workflow-search')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('workflow-status-filter')?.value || '';
            const priorityFilter = document.getElementById('workflow-priority-filter')?.value || '';
            const typeFilter = document.getElementById('workflow-type-filter')?.value || '';
            
            let records = getMockWorkflowRecords();
            
            // 应用搜索过滤
            if (searchTerm) {
                records = records.filter(record => 
                    record.archive_title.toLowerCase().includes(searchTerm) ||
                    record.requester_name.toLowerCase().includes(searchTerm) ||
                    record.workflow_number.toLowerCase().includes(searchTerm)
                );
            }
            
            // 应用状态过滤
            if (statusFilter) {
                records = records.filter(record => record.status === statusFilter);
            }
            
            // 应用优先级过滤
            if (priorityFilter) {
                records = records.filter(record => record.priority === priorityFilter);
            }
            
            // 应用类型过滤
            if (typeFilter) {
                records = records.filter(record => record.workflow_type === typeFilter);
            }
            
            displayWorkflowRecords(records);
        }

        function resetWorkflowFilters() {
            document.getElementById('workflow-search').value = '';
            document.getElementById('workflow-status-filter').value = '';
            document.getElementById('workflow-priority-filter').value = '';
            document.getElementById('workflow-type-filter').value = '';
            
            loadWorkflowRecords();
        }

        function refreshWorkflows() {
            loadWorkflowRecords();
            showAlert('工作流列表已刷新！', 'success');
        }

        function toggleWorkflowSelectAll() {
            const selectAllCheckbox = document.getElementById('workflow-select-all');
            const checkboxes = document.querySelectorAll('.workflow-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function exportWorkflowData() {
            showAlert('工作流数据导出功能正在开发中！', 'info');
        }

        function showAlert(message, type = 'info') {
            // 创建提示消息
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 初始化工作流面板
        function initWorkflowPanel() {
            // 为搜索框和筛选器添加事件监听器
            const searchInput = document.getElementById('workflow-search');
            const statusFilter = document.getElementById('workflow-status-filter');
            const priorityFilter = document.getElementById('workflow-priority-filter');
            const typeFilter = document.getElementById('workflow-type-filter');
            
            // 搜索框事件
            if (searchInput) {
                searchInput.addEventListener('input', debounce(searchWorkflows, 300));
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchWorkflows();
                    }
                });
            }
            
            // 筛选器事件
            if (statusFilter) {
                statusFilter.addEventListener('change', searchWorkflows);
            }
            
            if (priorityFilter) {
                priorityFilter.addEventListener('change', searchWorkflows);
            }
            
            if (typeFilter) {
                typeFilter.addEventListener('change', searchWorkflows);
            }
            
            // 工作流面板事件监听器初始化完成
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化工作流面板
            initWorkflowPanel();
            
            // 检查当前显示的面板
            const workflowPanel = document.getElementById('workflow-panel');
            if (workflowPanel && workflowPanel.style.display !== 'none') {
                loadWorkflowRecords();
            }
            
            // 性能优化：懒加载图片
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });
            
            images.forEach(img => imageObserver.observe(img));
            
            // 添加全局错误处理
            window.addEventListener('error', function(e) {
                console.error('全局错误:', e.error);
                showAlert('系统出现异常，请刷新页面重试', 'danger');
            });
            
            // 添加网络状态监控
            window.addEventListener('online', function() {
                showAlert('网络连接已恢复', 'success');
            });
            
            window.addEventListener('offline', function() {
                showAlert('网络连接已断开，部分功能可能受限', 'warning');
            });
        });

        // 监听面板显示切换
        function showWorkflowPanel() {
            document.getElementById('workflow-panel').style.display = 'block';
            loadWorkflowRecords();
        }

        // 加载统计数据
        async function loadStatisticsData() {
            try {
                const response = await fetch('/api/enhanced/statistics');
                if (response.ok) {
                    const data = await response.json();
                    displayStatisticsData(data);
                } else {
                    displayStatisticsData(getMockStatisticsData());
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
                displayStatisticsData(getMockStatisticsData());
            }
        }

        // 显示统计数据
        function displayStatisticsData(data) {
            try {
                // 更新图表（这里只是示例，实际需要使用图表库如Chart.js）
                if (!data) {
                    console.error('统计数据为空');
                    return;
                }
            
            // 模拟图表数据
            const categoryChart = document.getElementById('category-chart');
            if (categoryChart) {
                const ctx = categoryChart.getContext('2d');
                // 这里应该使用Chart.js绘制图表
                ctx.fillStyle = '#007bff';
                ctx.fillRect(50, 50, 200, 100);
                ctx.fillText('分类统计图表', 100, 120);
            }
            
            const statusChart = document.getElementById('status-chart');
            if (statusChart) {
                const ctx = statusChart.getContext('2d');
                ctx.fillStyle = '#28a745';
                ctx.fillRect(50, 50, 150, 100);
                ctx.fillText('状态统计图表', 70, 120);
            }
            } catch (error) {
                console.error('显示统计数据失败:', error);
            }
        }

        // 获取模拟统计数据
        function getMockStatisticsData() {
            return {
                category_distribution: {
                    '财务报告': 25,
                    '合同协议': 18,
                    '发票凭证': 32,
                    '合规文件': 12
                },
                status_distribution: {
                    '活跃': 89,
                    '已借出': 23,
                    '已归档': 44
                },
                monthly_growth: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45],
                department_usage: {
                    '财务部': 45,
                    '采购部': 23,
                    '人事部': 18,
                    '技术部': 35
                }
            };
        }

        // 搜索档案
        async function searchArchives() {
            const keyword = document.getElementById('archive-search').value;
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const security = document.getElementById('security-filter').value;
            
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (category) params.append('category', category);
            if (status) params.append('status', status);
            if (security) params.append('security_level', security);
            
            try {
                const response = await fetch(`/api/enhanced/archives/search?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    currentArchives = data.items || [];
                    displayArchives(currentArchives);
                } else {
                    // 使用客户端筛选
                    filterArchives();
                }
            } catch (error) {
                console.error('搜索失败:', error);
                filterArchives();
            }
        }

        // 客户端筛选档案
        function filterArchives() {
            const keyword = document.getElementById('archive-search').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const security = document.getElementById('security-filter').value;
            
            const filtered = currentArchives.filter(archive => {
                const matchKeyword = !keyword || 
                    archive.title.toLowerCase().includes(keyword) ||
                    archive.archive_number.toLowerCase().includes(keyword);
                const matchCategory = !category || archive.category === category;
                const matchStatus = !status || archive.status === status;
                const matchSecurity = !security || archive.security_level === security;
                
                return matchKeyword && matchCategory && matchStatus && matchSecurity;
            });
            
            displayArchives(filtered);
        }

        // ================================
        // 生命周期管理相关函数
        // ================================

        // 加载生命周期记录
        async function loadLifecycleRecords() {
            try {
                const response = await fetch('/api/enhanced/lifecycle-records');
                if (response.ok) {
                    const data = await response.json();
                    displayLifecycleRecords(data.items || getMockLifecycleRecords());
                } else {
                    displayLifecycleRecords(getMockLifecycleRecords());
                }
            } catch (error) {
                console.error('加载生命周期记录失败:', error);
                displayLifecycleRecords(getMockLifecycleRecords());
            }
        }

        // 显示生命周期记录
        function displayLifecycleRecords(records) {
            const tbody = document.querySelector('#lifecycle-records-table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const statusClass = {
                    'pending': 'warning',
                    'approved': 'success',
                    'rejected': 'danger',
                    'completed': 'info'
                }[record.approval_status] || 'secondary';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.archive_title}</td>
                    <td>${getEventTypeDisplayName(record.event_type)}</td>
                    <td>${record.operator_name || '-'}</td>
                    <td>${record.event_date}</td>
                    <td>
                        <span class="badge bg-${statusClass}">${getApprovalStatusDisplayName(record.approval_status)}</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewLifecycleDetail('${record.id}')">
                                <i class="fas fa-eye"></i> 查看
                            </button>
                            <button class="btn btn-outline-success" onclick="quickTrigger('${record.archive_id}', '${record.event_type}')">
                                <i class="fas fa-play"></i> 触发
                            </button>
                            <button class="btn btn-outline-warning" onclick="viewStatistics()">
                                <i class="fas fa-chart-bar"></i> 统计
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 获取事件类型显示名称
        function getEventTypeDisplayName(eventType) {
            const eventTypeMap = {
                'created': '创建',
                'archived': '归档',
                'transferred': '转移',
                'disposed': '销毁',
                'migrated': '迁移',
                'restored': '恢复'
            };
            return eventTypeMap[eventType] || eventType;
        }

        // 获取审批状态显示名称
        function getApprovalStatusDisplayName(status) {
            const statusMap = {
                'pending': '待审批',
                'approved': '已批准',
                'rejected': '已拒绝',
                'completed': '已完成'
            };
            return statusMap[status] || status;
        }

        // 获取模拟生命周期记录
        function getMockLifecycleRecords() {
            return [
                {
                    id: '1',
                    archive_id: '1',
                    archive_title: '2023年度财务报告',
                    event_type: 'created',
                    operator_name: '张财务',
                    event_date: '2023-12-01',
                    description: '创建年度财务报告档案',
                    approval_status: 'approved'
                },
                {
                    id: '2',
                    archive_id: '2',
                    archive_title: '办公用品采购合同',
                    event_type: 'archived',
                    operator_name: '李采购',
                    event_date: '2023-12-05',
                    description: '合同已归档至永久存储',
                    approval_status: 'completed'
                },
                {
                    id: '3',
                    archive_id: '3',
                    archive_title: '增值税发票汇总',
                    event_type: 'transferred',
                    operator_name: '王会计',
                    event_date: '2023-12-10',
                    description: '档案转移至异地存储',
                    approval_status: 'pending'
                },
                {
                    id: '4',
                    archive_id: '4',
                    archive_title: '员工薪酬调整方案',
                    event_type: 'migrated',
                    operator_name: '人事部',
                    event_date: '2023-12-15',
                    description: '升级存储系统，档案迁移',
                    approval_status: 'approved'
                }
            ];
        }

        // 显示事件类型信息
        function updateEventDescription() {
            const eventType = document.querySelector('#quickTriggerForm select[name="event_type"]').value;
            const infoElement = document.getElementById('event-info');
            
            const eventInfoMap = {
                'created': '创建新的档案记录，进入系统初始状态',
                'archived': '将档案归档至长期存储，需要审批',
                'transferred': '将档案转移至其他存储位置或部门',
                'disposed': '销毁达到保存期限的档案，不可逆操作',
                'migrated': '将档案迁移到新的存储系统',
                'restored': '从备份或归档中恢复档案'
            };
            
            if (infoElement) {
                infoElement.textContent = eventInfoMap[eventType] || '选择事件类型查看说明';
            }
        }

        // 快速触发事件
        async function quickTriggerEvent() {
            const form = document.getElementById('quickTriggerForm');
            const formData = new FormData(form);
            
            const data = {
                archive_id: formData.get('archive_id'),
                event_type: formData.get('event_type'),
                description: `快速触发${getEventTypeDisplayName(formData.get('event_type'))}事件`
            };
            
            try {
                const response = await fetch('/api/enhanced/lifecycle-records/quick-trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('success', `事件触发成功: ${result.message}`);
                    bootstrap.Modal.getInstance(document.getElementById('quickTriggerModal')).hide();
                    loadLifecycleRecords(); // 重新加载记录
                } else {
                    const error = await response.json();
                    showAlert('danger', `触发失败: ${error.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('快速触发事件失败:', error);
                showAlert('danger', '触发失败，请检查网络连接');
            }
        }

        // 快速触发
        function quickTrigger(archiveId, eventType) {
            const modal = new bootstrap.Modal(document.getElementById('quickTriggerModal'));
            modal.show();
            
            // 预填表单
            const form = document.getElementById('quickTriggerForm');
            form.querySelector('input[name="archive_id"]').value = archiveId;
            form.querySelector(`select[name="event_type"] option[value="${eventType}"]`).selected = true;
            updateEventDescription();
        }

        // 查看生命周期记录详情
        async function viewLifecycleDetail(recordId) {
            try {
                const response = await fetch(`/api/enhanced/lifecycle-records/${recordId}`);
                if (response.ok) {
                    const record = await response.json();
                    showLifecycleDetail(record);
                } else {
                    // 使用模拟数据
                    const record = getMockLifecycleRecords().find(r => r.id === recordId);
                    if (record) {
                        showLifecycleDetail(record);
                    }
                }
            } catch (error) {
                console.error('获取记录详情失败:', error);
                showAlert('danger', '获取记录详情失败');
            }
        }

        // 显示记录详情
        function showLifecycleDetail(record) {
            const content = document.getElementById('lifecycle-detail-content');
            if (!content) return;
            
            content.innerHTML = `
 `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><th>档案ID:</th><td>${record.archive_id}</td></tr>
                            <tr><th>档案标题:</th><td>${record.archive_title}</td></tr>
                            <tr><th>事件类型:</th><td>${getEventTypeDisplayName(record.event_type)}</td></tr>
                            <tr><th>操作人:</th><td>${record.operator_name || '-'}</td></tr>
                            <tr><th>事件日期:</th><td>${record.event_date}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>审批信息</h6>
                        <table class="table table-sm">
                            <tr><th>审批状态:</th><td>
                                <span class="badge bg-${getStatusColor(record.approval_status)}">${getApprovalStatusDisplayName(record.approval_status)}</span>
                            </td></tr>
                            <tr><th>创建时间:</th><td>${record.created_at || '-'}</td></tr>
                            <tr><th>更新时间:</th><td>${record.updated_at || '-'}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>事件描述</h6>
                    <p class="text-muted">${record.description}</p>
                </div>
                ${}}
            `           
            const modal = new bootstrap.Modal(document.getElementById('lifecycleDetailModal'));
            modal.show();
        }

        // 获取状态颜色
        function getStatusColor(status) {
            const colorMap = {
                'pending': 'warning',
                'approved': 'success',
                'rejected': 'danger',
                'completed': 'info'
            };
            return colorMap[status] || 'secondary';
        }

        // 查看统计信息
        async function viewStatistics() {
            try {
                const response = await fetch('/api/enhanced/lifecycle-records/statistics');
                if (response.ok) {
                    const statistics = await response.json();
                    showStatisticsChart(statistics);
                } else {
                    showStatisticsChart(getMockStatistics());
                }
            } catch (error) {
                console.error('获取统计信息失败:', error);
                showStatisticsChart(getMockStatistics());
            }
        }

        // 显示统计图表
        function showStatisticsChart(statistics) {
            try {
                // TODO: 使用Chart.js等图表库绘制图表
                if (!statistics || !statistics.total_records) {
                    showAlert('统计数据异常，请重试', 'warning');
                    return;
                }
                
                showAlert(`统计信息已获取，共${statistics.total_records || 0}条记录`, 'success');
            } catch (error) {
                console.error('显示统计图表失败:', error);
                showAlert('统计图表显示异常', 'error');
            }
        }

        // 获取模拟统计数据
        function getMockStatistics() {
            return {
                total_records: 156,
                event_type_distribution: {
                    'created': 45,
                    'archived': 32,
                    'transferred': 28,
                    'disposed': 12,
                    'migrated': 25,
                    'restored': 14
                },
                monthly_trend: [
                    {month: '1月', count: 12},
                    {month: '2月', count: 15},
                    {month: '3月', count: 18},
                    {month: '4月', count: 22},
                    {month: '5月', count: 19},
                    {month: '6月', count: 25}
                ],
                approval_status_distribution: {
                    'approved': 98,
                    'pending': 23,
                    'rejected': 8,
                    'completed': 27
                }
            };
        }

        // 创建生命周期记录
        async function createLifecycleRecord() {
            const form = document.getElementById('createLifecycleForm');
            const formData = new FormData(form);
            
            const data = {
                archive_id: formData.get('archive_id'),
                event_type: formData.get('event_type'),
                event_date: formData.get('event_date') || new Date().toISOString().split('T')[0],
                description: formData.get('description'),
                approval_required: formData.get('approval_required') === 'on',
                is_automated: formData.get('is_automated') === 'on',
                automation_rule: formData.get('automation_rule'),
                metadata: formData.get('metadata')
            };
            
            try {
                const response = await fetch('/api/enhanced/lifecycle-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('success', `生命周期记录创建成功: ${result.message}`);
                    bootstrap.Modal.getInstance(document.getElementById('createLifecycleModal')).hide();
                    form.reset();
                    loadLifecycleRecords(); // 重新加载记录
                } else {
                    const error = await response.json();
                    showAlert('danger', `创建失败: ${error.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('创建生命周期记录失败:', error);
                showAlert('danger', '创建失败，请检查网络连接');
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    // 统计分析相关变量
    let statisticsCharts = {};
    let currentStatisticsData = {};

    // 初始化统计面板
    function initStatisticsPanel() {
        loadStatisticsData();
        initStatisticsFilters();
        initStatisticsEventListeners();
    }

    // 加载统计数据
    async function loadStatisticsData() {
        try {
            // 模拟API调用，实际应该调用统计API
            const mockData = await getMockStatisticsData();
            currentStatisticsData = mockData;
            updateStatisticsOverview(mockData.overview);
            updateStatisticsTable(mockData.detailed);
            updateStatisticsCharts();
            updateTrendAnalysis(mockData.trends);
        } catch (error) {
            console.error('加载统计数据失败:', error);
            showAlert('加载统计数据失败，请稍后重试', 'error');
        }
    }

    // 获取模拟统计数据
    async function getMockStatisticsData() {
        // 模拟API延迟
        await new Promise(resolve => setTimeout(resolve, 500));
        
        return {
            overview: {
                totalArchives: 1247,
                activeArchives: 892,
                pendingWorkflows: 45,
                storageUsed: 2560, // MB
                growthRates: {
                    archives: 15.3,
                    active: 12.8,
                    workflows: -8.5,
                    storage: 8.2
                }
            },
            detailed: [
                {
                    category: '财务报告',
                    total: 342,
                    active: 278,
                    archived: 64,
                    pending: 12,
                    storage: 856,
                    growth: 18.5,
                    lastUpdate: '2024-01-15'
                },
                {
                    category: '合同协议',
                    total: 256,
                    active: 198,
                    archived: 58,
                    pending: 8,
                    storage: 512,
                    growth: 12.3,
                    lastUpdate: '2024-01-14'
                },
                {
                    category: '发票凭证',
                    total: 418,
                    active: 312,
                    archived: 106,
                    pending: 15,
                    storage: 384,
                    growth: 22.1,
                    lastUpdate: '2024-01-15'
                },
                {
                    category: '合规文件',
                    total: 231,
                    active: 104,
                    archived: 127,
                    pending: 10,
                    storage: 808,
                    growth: 5.7,
                    lastUpdate: '2024-01-13'
                }
            ],
            charts: {
                categoryDistribution: {
                    labels: ['财务报告', '合同协议', '发票凭证', '合规文件'],
                    data: [342, 256, 418, 231],
                    colors: ['#007bff', '#28a745', '#ffc107', '#17a2b8']
                },
                creationTrend: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                    data: [45, 52, 48, 61, 58, 67],
                    datasets: [
                        { label: '档案创建', data: [45, 52, 48, 61, 58, 67], borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)' },
                        { label: '档案归档', data: [12, 18, 15, 22, 19, 25], borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)' }
                    ]
                },
                securityLevel: {
                    labels: ['公开', '内部', '机密', '秘密', '绝密'],
                    data: [156, 389, 478, 186, 38],
                    backgroundColor: ['#6c757d', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545']
                },
                workflowStatus: {
                    labels: ['待审核', '进行中', '已完成', '已拒绝'],
                    data: [45, 128, 892, 23],
                    backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
                }
            },
            trends: {
                growthRate: 15.3,
                efficiency: 87.5,
                storageEfficiency: 92.1
            }
        };
    }

    // 更新统计概览
    function updateStatisticsOverview(overview) {
        document.getElementById('stats-total-archives').textContent = overview.totalArchives.toLocaleString();
        document.getElementById('stats-active-archives').textContent = overview.activeArchives.toLocaleString();
        document.getElementById('stats-pending-workflows').textContent = overview.pendingWorkflows;
        document.getElementById('stats-storage-used').textContent = formatFileSize(overview.storageUsed * 1024 * 1024);
        
        document.getElementById('stats-archives-growth').textContent = 
            (overview.growthRates.archives > 0 ? '+' : '') + overview.growthRates.archives + '%';
        document.getElementById('stats-active-growth').textContent = 
            (overview.growthRates.active > 0 ? '+' : '') + overview.growthRates.active + '%';
        document.getElementById('stats-workflows-growth').textContent = 
            (overview.growthRates.workflows > 0 ? '+' : '') + overview.growthRates.workflows + '%';
        document.getElementById('stats-storage-growth').textContent = 
            (overview.growthRates.storage > 0 ? '+' : '') + overview.growthRates.storage + '%';
        
        // 设置颜色类
        setGrowthColor('stats-archives-growth', overview.growthRates.archives);
        setGrowthColor('stats-active-growth', overview.growthRates.active);
        setGrowthColor('stats-workflows-growth', overview.growthRates.workflows);
        setGrowthColor('stats-storage-growth', overview.growthRates.storage);
    }

    // 设置增长率颜色
    function setGrowthColor(elementId, growth) {
        const element = document.getElementById(elementId);
        if (growth > 0) {
            element.className = 'text-success';
        } else if (growth < 0) {
            element.className = 'text-danger';
        } else {
            element.className = 'text-muted';
        }
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // 更新统计表格
    function updateStatisticsTable(data) {
        const tbody = document.getElementById('statistics-table-body');
        tbody.innerHTML = '';
        
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${item.category}</strong></td>
                <td>${item.total}</td>
                <td><span class="text-success">${item.active}</span></td>
                <td><span class="text-muted">${item.archived}</span></td>
                <td><span class="text-warning">${item.pending}</span></td>
                <td>${formatFileSize(item.storage * 1024 * 1024)}</td>
                <td><span class="${item.growth > 0 ? 'text-success' : 'text-danger'}">
                    ${item.growth > 0 ? '+' : ''}${item.growth}%
                </span></td>
                <td>${item.lastUpdate}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // 更新统计图表
    function updateStatisticsCharts() {
        try {
            // 检查Chart.js是否已加载
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js未加载，图表功能不可用');
                return;
            }
            
            updateCategoryDistributionChart();
            updateCreationTrendChart();
            updateSecurityLevelChart();
            updateWorkflowStatusChart();
            updateTrendCharts();
        } catch (error) {
            console.error('更新图表失败:', error);
        }
    }

    // 更新分类分布饼图
    function updateCategoryDistributionChart() {
        const ctx = document.getElementById('categoryDistributionChart');
        if (!ctx) return;
        
        const data = currentStatisticsData.charts.categoryDistribution;
        
        // 销毁现有图表
        if (statisticsCharts.categoryDistribution) {
            statisticsCharts.categoryDistribution.destroy();
        }
        
        statisticsCharts.categoryDistribution = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: data.colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // 更新创建趋势线图
    function updateCreationTrendChart() {
        const ctx = document.getElementById('creationTrendChart');
        if (!ctx) return;
        
        const data = currentStatisticsData.charts.creationTrend;
        
        if (statisticsCharts.creationTrend) {
            statisticsCharts.creationTrend.destroy();
        }
        
        statisticsCharts.creationTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            }
        });
    }

    // 更新保密等级柱状图
    function updateSecurityLevelChart() {
        const ctx = document.getElementById('securityLevelChart');
        if (!ctx) return;
        
        const data = currentStatisticsData.charts.securityLevel;
        
        if (statisticsCharts.securityLevel) {
            statisticsCharts.securityLevel.destroy();
        }
        
        statisticsCharts.securityLevel = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '档案数量',
                    data: data.data,
                    backgroundColor: data.backgroundColor,
                    borderWidth: 0,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // 更新工作流状态统计图
    function updateWorkflowStatusChart() {
        const ctx = document.getElementById('workflowStatusChart');
        if (!ctx) return;
        
        const data = currentStatisticsData.charts.workflowStatus;
        
        if (statisticsCharts.workflowStatus) {
            statisticsCharts.workflowStatus.destroy();
        }
        
        statisticsCharts.workflowStatus = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '工作流数量',
                    data: data.data,
                    backgroundColor: data.backgroundColor,
                    borderWidth: 0,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // 更新趋势分析图表
    function updateTrendCharts() {
        updateGrowthTrendChart();
        updateEfficiencyChart();
        updateStorageEfficiencyChart();
    }

    // 更新增长率趋势图
    function updateGrowthTrendChart() {
        const ctx = document.getElementById('growthTrendChart');
        if (!ctx) return;
        
        const data = [12.5, 13.8, 14.2, 15.1, 15.8, 15.3]; // 最近6个月增长率
        const labels = ['8月', '9月', '10月', '11月', '12月', '1月'];
        
        if (statisticsCharts.growthTrend) {
            statisticsCharts.growthTrend.destroy();
        }
        
        statisticsCharts.growthTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { display: false },
                    y: { 
                        display: false,
                        min: 10,
                        max: 20
                    }
                }
            }
        });
    }

    // 更新效率图表
    function updateEfficiencyChart() {
        const ctx = document.getElementById('efficiencyChart');
        if (!ctx) return;
        
        const data = [85.2, 86.1, 86.8, 87.2, 87.5, 87.5]; // 最近6个月效率
        const labels = ['8月', '9月', '10月', '11月', '12月', '1月'];
        
        if (statisticsCharts.efficiency) {
            statisticsCharts.efficiency.destroy();
        }
        
        statisticsCharts.efficiency = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { display: false },
                    y: { 
                        display: false,
                        min: 80,
                        max: 95
                    }
                }
            }
        });
    }

    // 更新存储效率图表
    function updateStorageEfficiencyChart() {
        const ctx = document.getElementById('storageEfficiencyChart');
        if (!ctx) return;
        
        const data = [88.5, 89.2, 90.1, 91.3, 91.8, 92.1]; // 最近6个月存储效率
        const labels = ['8月', '9月', '10月', '11月', '12月', '1月'];
        
        if (statisticsCharts.storageEfficiency) {
            statisticsCharts.storageEfficiency.destroy();
        }
        
        statisticsCharts.storageEfficiency = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { display: false },
                    y: { 
                        display: false,
                        min: 85,
                        max: 100
                    }
                }
            }
        });
    }

    // 初始化统计筛选器
    function initStatisticsFilters() {
        // 设置默认筛选条件
        document.getElementById('stats-date-range').value = 'month';
        document.getElementById('stats-category-filter').value = '';
        document.getElementById('stats-security-filter').value = '';
        document.getElementById('stats-department-filter').value = '';
    }

    // 初始化统计事件监听器
    function initStatisticsEventListeners() {
        // 监听统计面板显示/隐藏
        document.addEventListener('click', function(e) {
            if (e.target.matches('[data-panel="statistics"]')) {
                setTimeout(() => {
                    initStatisticsPanel();
                }, 100);
            }
        });
    }

    // 刷新统计面板
    function refreshStatistics() {
        showAlert('正在刷新统计数据...', 'info');
        loadStatisticsData().then(() => {
            showAlert('统计数据已更新', 'success');
        }).catch(error => {
            showAlert('刷新统计数据失败', 'error');
        });
    }

    // 更新统计图表（根据筛选条件）
    function updateStatisticsCharts() {
        // 这里可以根据筛选条件重新加载数据并更新图表
        setTimeout(() => {
            updateStatisticsCharts();
        }, 100);
    }

    // 导出统计报表
    function exportStatisticsReport() {
        try {
            const data = currentStatisticsData;
            const reportData = {
                exportTime: new Date().toLocaleString(),
                overview: data.overview,
                detailed: data.detailed,
                trends: data.trends
            };
            
            const blob = new Blob([JSON.stringify(reportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `档案统计报表_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('统计报表已导出', 'success');
        } catch (error) {
            console.error('导出失败:', error);
            showAlert('导出统计报表失败', 'error');
        }
    }

    // 生成详细报告
    function generateDetailedReport() {
        try {
            showAlert('正在生成详细报告...', 'info');
            
            setTimeout(() => {
                const reportWindow = window.open('', '_blank');
                if (reportWindow) {
                    reportWindow.document.writ`
    `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>档案统计分析详细报告</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                .header { text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 20px; margin-bottom: 30px; }
                                .section { margin-bottom: 30px; }
                                .section h2 { color: #007bff; border-left: 4px solid #007bff; padding-left: 10px; }
                                .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
                                .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; }
                                .stat-value { font-size: 2em; font-weight: bold; color: #007bff; }
                                .stat-label { color: #6c757d; margin-top: 5px; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
                                th { background-color: #007bff; color: white; }
                                .trend-up { color: #28a745; }
                                .trend-down { color: #dc3545; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>档案统计分析详细报告</h1>
                                <p>生成时间: ${new Date().toLocaleString()}</p>
                            </div>
                            
                            <div class="section">
                                <h2>统计概览</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value">${currentStatisticsData.overview.totalArchives.toLocaleString()}</div>
                                        <div class="stat-label">档案总数</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${currentStatisticsData.overview.activeArchives.toLocaleString()}</div>
                                        <div class="stat-label">活跃档案</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${currentStatisticsData.overview.pendingWorkflows}</div>
                                        <div class="stat-label">待审核工作流</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${formatFileSize(currentStatisticsData.overview.storageUsed * 1024 * 1024)}</div>
                                        <div class="stat-label">存储占用</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <h2>详细统计</h2>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>档案类型</th>
                                            <th>总数</th>
                                            <th>活跃</th>
                                            <th>归档</th>
                                            <th>待审核</th>
                                            <th>存储占用</th>
                                            <th>增长率</th>
                                            <th>最后更新</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${currentStatisticsData.detailed.map(item => }                                         <tr>
                                                <td>${item.category}</td>
                                                <td>${item.total}</td>
                                                <td>${item.active}</td>
                                                <td>${item.archived}</td>
                                                <td>${item.pending}</td>
                                                <td>${formatFileSize(item.storage * 1024 * 1024)}</td>
                                                <td class="${item.growth > 0 ? 'trend-up' : 'trend-down'}">
                                                    ${item.growth > 0 ? '+' : ''}${item.growth}%
                                                </td>
                                                <td>${item.lastUpdate}</td>
                                            </tr>
                                      `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h2>趋势分析</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value">+${currentStatisticsData.trends.growthRate}%</div>
                                        <div class="stat-label">档案增长率</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${currentStatisticsData.trends.efficiency}%</div>
                                        <div class="stat-label">工作流效率</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${currentStatisticsData.trends.storageEfficiency}%</div>
                                        <div class="stat-label">存储效率</div>
                                    </div>
                                </div>
                            </div>
                        </body>
                        </html>
                    `` `);
                    reportWindow.document.close();
                    showAlert('详细报告已生成', 'success');
                } else {
                    showAlert('无法打开报告窗口，请检查弹窗设置', 'error');
                }
            }, 1000);
        } catch (error) {
            console.error('生成详细报告时发生错误:', error);
            showAlert('生成报告失败，请稍后重试。', 'error');
        }
    }

    // 导出Excel
    function exportToExcel() {
        showAlert('正在导出Excel文件...', 'info');
        
        // 这里应该调用服务器端API来生成Excel文件
        // 暂时模拟导出过程
        setTimeout(() => {
            showAlert('Excel导出功能需要后端支持', 'warning');
        }, 1000);
    }

    // 导出PDF
    function exportToPDF() {
        showAlert('正在导出PDF文件...', 'info');
        
        // 这里应该调用服务器端API来生成PDF文件
        // 暂时模拟导出过程
        setTimeout(() => {
            showAlert('PDF导出功能需要后端支持', 'warning');
        }, 1000);
    }

    // 显示统计面板
    function showStatisticsPanel() {
        showPanel('statistics');
        initStatisticsPanel();
    }

    </script>
</body>
</html>